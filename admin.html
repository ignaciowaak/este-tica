<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel ‚Äî Gesti√≥n Profesional de Turnos</title>
  <!-- Fuentes profesionales -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Manrope:wght@200;300;400;500;600;700;800&family=Geist:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    :root{
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #64748b;
      --accent: #440D13;
      --accent-light: #5a1119;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --border: #e2e8f0;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --shadow: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
      --radius: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: 'Geist', system-ui, sans-serif;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
      font-family: 'Geist', system-ui, sans-serif;
      color: var(--text-primary);
    }
    
    main {
      width: 100%;
      max-width: 1200px;
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Header mejorado */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding: 32px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    
    h1 {
      margin: 0;
      font-size: 2.5rem;
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.02em;
    }
    
    header p {
      margin: 8px 0 0 0;
      color: var(--text-secondary);
      font-size: 1.1rem;
      font-family: 'Manrope', sans-serif;
    }
    
    #info {
      color: var(--muted);
      font-family: 'Manrope', sans-serif;
      font-weight: 500;
      padding: 8px 16px;
      background: rgba(68, 13, 19, 0.1);
      border-radius: 8px;
    }
    
    /* Panel de login mejorado */
    .loginBox {
      max-width: 480px;
      margin: 60px auto;
      padding: 40px;
      background: var(--card);
      border-radius: 24px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
      animation: slideInUp 0.6s ease-out;
    }

    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .loginBox h3 {
      margin: 0 0 24px 0;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 2rem;
      font-weight: 700;
      text-align: center;
      color: var(--text-primary);
    }
    
    /* Panel principal mejorado */
    .panel {
      background: var(--card);
      padding: 32px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      animation: slideInUp 0.6s ease-out;
    }
    
    /* Formularios mejorados */
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      align-items: end;
      margin-bottom: 24px;
      padding: 24px;
      background: rgba(248, 250, 252, 0.8);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }
    
    label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 600;
      font-family: 'Manrope', sans-serif;
      margin-bottom: 6px;
      display: block;
    }
    
    input, select, textarea, button {
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 1rem;
      font-family: 'Manrope', sans-serif;
      transition: var(--transition);
      outline: none;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(68, 13, 19, 0.1);
      transform: translateY(-1px);
    }
    
    /* Botones mejorados */
    .btn {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
      border: 0;
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      min-width: 120px;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s ease;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(68, 13, 19, 0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    /* Grid de turnos mejorado */
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-top: 24px;
    }
    
    /* Tarjetas de turno mejoradas */
    .turno {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 24px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      justify-content: space-between;
      flex-wrap: wrap;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    
    .turno::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-light));
      opacity: 0;
      transition: var(--transition);
    }
    
    .turno:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    .turno:hover::before {
      opacity: 1;
    }
    
    .left {
      display: flex;
      gap: 20px;
      align-items: center;
      flex: 1;
    }
    
    .meta {
      min-width: 200px;
    }
    
    .meta strong {
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .muted {
      color: var(--muted);
      font-family: 'Manrope', sans-serif;
    }
    
    .actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .btn-edit {
      background: white;
      border: 1px solid var(--border);
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-family: 'Manrope', sans-serif;
      transition: var(--transition);
    }
    
    .btn-edit:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    
    .btn-delete {
      background: var(--danger);
      color: white;
      padding: 10px 16px;
      border-radius: 10px;
      border: 0;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }
    
    .btn-delete:hover {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
    }
    
    /* Estados mejorados */
    .status-res {
      color: var(--danger);
      font-weight: 700;
      font-family: 'Space Grotesk', sans-serif;
    }
    
    .status-ava {
      color: var(--success);
      font-weight: 700;
      font-family: 'Space Grotesk', sans-serif;
    }
    
    /* Im√°genes mejoradas */
    .images {
      display: flex;
      gap: 12px;
      overflow: auto;
      padding: 8px 0;
    }
    
    .images img {
      height: 80px;
      width: 80px;
      border-radius: 12px;
      object-fit: cover;
      transition: var(--transition);
      cursor: pointer;
      border: 2px solid transparent;
    }
    
    .images img:hover {
      transform: scale(1.1);
      border-color: var(--accent);
      box-shadow: 0 8px 25px rgba(68, 13, 19, 0.3);
    }
    
    /* Barras de progreso mejoradas */
    .progressWrap {
      width: 100%;
      background: #f1f5f9;
      border-radius: 8px;
      height: 8px;
      overflow: hidden;
      margin-top: 12px;
      border: 1px solid var(--border);
      display: none;
    }
    
    .progressBar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent-light));
      transition: width 0.3s ease;
      position: relative;
    }
    
    .progressBar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: progressShine 2s ease-in-out infinite;
    }
    
    @keyframes progressShine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .progressText {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 8px;
      font-family: 'Manrope', sans-serif;
      font-weight: 500;
      display: none;
    }
    
    /* Vista previa mejorada */
    .promoPreview img {
      height: 80px;
      width: 120px;
      border-radius: 12px;
      object-fit: cover;
      border: 2px solid var(--border);
      transition: var(--transition);
    }
    
    .promoPreview img:hover {
      transform: scale(1.05);
      border-color: var(--accent);
    }
    
    /* Mensajes mejorados */
    .msg {
      padding: 16px 20px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      font-family: 'Manrope', sans-serif;
      animation: slideIn 0.4s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .msg.success {
      background: #f0fdf4;
      color: var(--success);
      border: 1px solid #bbf7d0;
    }
    
    .msg.error {
      background: #fef2f2;
      color: var(--danger);
      border: 1px solid #fecaca;
    }
    
    .msg.success::before {
      content: '‚úÖ';
    }
    
    .msg.error::before {
      content: '‚ùå';
    }
    
    /* Campos adicionales para ubicaci√≥n GPS */
    .location-inputs {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 12px;
      align-items: end;
    }
    
    .gps-toggle {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      font-size: 0.9rem;
      padding: 8px 12px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .gps-toggle:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    .gps-toggle.active {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }
    
    /* Responsive mejorado */
    @media (max-width: 768px) {
      body {
        padding: 12px;
      }
      
      header {
        flex-direction: column;
        align-items: flex-start;
        text-align: center;
        gap: 16px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      form {
        grid-template-columns: 1fr;
        padding: 20px;
      }
      
      .location-inputs {
        grid-template-columns: 1fr;
      }
      
      .left {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .turno {
        padding: 20px;
        gap: 16px;
      }
      
      .actions {
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .loginBox {
        margin: 20px auto;
        padding: 24px;
      }
    }
    
    /* Loading spinner */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

  </style>
</head>
<body>
  <main>
    <header>
      <div>
        <h1>Panel de Administraci√≥n</h1>
        <p>Gesti√≥n profesional de turnos y reservas</p>
      </div>
      <div id="info">Conectando...</div>
    </header>

    <!-- PANTALLA DE LOGIN -->
    <div id="loginScreen" class="loginBox" aria-live="polite">
      <h3>üîê Acceso Administrativo</h3>
      <div style="display:flex;flex-direction:column;gap:16px;margin-top:24px">
        <input id="adminEmail" type="email" placeholder="admin@ejemplo.com" required>
        <input id="adminPass" type="password" placeholder="Contrase√±a de administrador" required>
        <div style="display:flex;gap:12px;align-items:center;">
          <button id="btnLogin" class="btn">
            <span id="loginSpinner" class="loading" style="display:none;"></span>
            Iniciar Sesi√≥n
          </button>
          <div id="loginMsg" class="muted"></div>
        </div>
      </div>
    </div>

    <!-- PANEL PRINCIPAL -->
    <section id="panel" class="panel" style="display:none">
      <!-- Info del usuario -->
      <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap;margin-bottom:32px;">
        <div>
          <strong style="font-family:'Space Grotesk',sans-serif;">Sesi√≥n activa:</strong> 
          <span id="whoami" style="color:var(--accent);font-weight:600;"></span>
        </div>
        <button id="btnLogout" class="btn" style="background:var(--warning);color:white;">
          Cerrar Sesi√≥n
        </button>
      </div>

      <hr style="margin:32px 0;border:none;height:1px;background:var(--border);">

      <!-- Gesti√≥n de Logo -->
      <div style="margin-bottom:32px;padding:24px;background:rgba(16,185,129,0.05);border-radius:var(--radius);border:1px solid rgba(16,185,129,0.2);">
        <h3 style="margin:0 0 20px 0;font-family:'Space Grotesk',sans-serif;color:var(--success);">üñºÔ∏è Logo del Sitio</h3>
        <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap;">
          <div>
            <label><strong>Seleccionar logo</strong></label>
            <input id="logoFile" type="file" accept="image/*" style="margin-top:8px;">
          </div>
          <button id="uploadLogoBtn" class="btn">Subir Logo</button>
          <div id="logoPreview" style="display:flex;align-items:center;gap:12px;"></div>
        </div>
      </div>

      <!-- Gesti√≥n de Promoci√≥n -->
      <div style="margin-bottom:32px;padding:24px;background:rgba(245,158,11,0.05);border-radius:var(--radius);border:1px solid rgba(245,158,11,0.2);">
        <h3 style="margin:0 0 20px 0;font-family:'Space Grotesk',sans-serif;color:var(--warning);">üéâ Imagen Promocional</h3>
        <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin-bottom:16px;">
          <div>
            <label><strong>Seleccionar promoci√≥n</strong></label>
            <input id="promoFile" type="file" accept="image/*" style="margin-top:8px;">
          </div>
          <button id="uploadPromoBtn" class="btn">Subir Promoci√≥n</button>
          <div class="promoPreview" id="promoPreview"></div>
          <button id="deletePromoBtn" class="btn-delete">Eliminar Promoci√≥n</button>
        </div>
        <div class="progressWrap" id="promoProgressWrap">
          <div class="progressBar" id="promoProgressBar"></div>
        </div>
        <div class="progressText" id="promoProgressText"></div>
      </div>

      <!-- Formulario para agregar turnos -->
      <div style="margin-bottom:32px;padding:24px;background:rgba(68,13,19,0.05);border-radius:var(--radius);border:1px solid rgba(68,13,19,0.2);">
        <h3 style="margin:0 0 24px 0;font-family:'Space Grotesk',sans-serif;color:var(--accent);">‚ûï Agregar Nuevo Turno</h3>
        
        <form id="formAdd" onsubmit="return false;">
          <div>
            <label for="fecha">üìÖ Fecha</label>
            <input id="fecha" type="date" required>
          </div>
          <div>
            <label for="hora">üïê Hora</label>
            <input id="hora" type="time" required>
          </div>
          <div>
            <label for="precio">üí∞ Precio (ARS)</label>
            <input id="precio" type="number" min="0" required placeholder="5000">
          </div>
          
          <!-- Campos de ubicaci√≥n mejorados con GPS -->
          <div class="location-inputs">
            <div>
              <label for="ubicacion">üìç Ubicaci√≥n / Direcci√≥n</label>
              <input id="ubicacion" type="text" placeholder="Calle, n√∫mero, ciudad" style="width:100%;">
            </div>
            <div>
              <label for="latitud">üåê Latitud (opcional)</label>
              <input id="latitud" type="number" step="any" placeholder="-34.6037">
            </div>
            <div>
              <label for="longitud">üåê Longitud (opcional)</label>
              <input id="longitud" type="number" step="any" placeholder="-58.3816">
            </div>
          </div>
          
          <div style="grid-column: 1 / -1;">
            <label for="descripcion">üìù Descripci√≥n / Detalles</label>
            <textarea id="descripcion" rows="3" style="width:100%;border-radius:12px;resize:vertical;" placeholder="Descripci√≥n detallada del servicio..."></textarea>
          </div>
          
          <div style="grid-column: 1 / -1;display:flex;gap:16px;align-items:end;flex-wrap:wrap;">
            <div style="flex:1;min-width:200px;">
              <label>üñºÔ∏è Fotos del turno (m√∫ltiples)</label>
              <input id="photos" type="file" accept="image/*" multiple style="margin-top:8px;">
            </div>
            <button id="addBtn" class="btn" style="height:48px;min-width:160px;">
              <span id="addSpinner" class="loading" style="display:none;"></span>
              Agregar Turno
            </button>
          </div>

          <!-- Barra de progreso para subida -->
          <div class="progressWrap" id="turnoProgressWrap" style="grid-column: 1 / -1;">
            <div class="progressBar" id="turnoProgressBar"></div>
          </div>
          <div class="progressText" id="turnoProgressText" style="grid-column: 1 / -1;"></div>
        </form>
      </div>

      <div id="messageArea" style="margin-bottom:24px;"></div>

      <!-- Lista de turnos -->
      <div style="margin-top:32px">
        <h3 style="margin:0 0 24px 0;font-family:'Space Grotesk',sans-serif;font-size:1.8rem;">üìã Turnos Registrados</h3>
        <div id="turnosList" class="grid" aria-live="polite"></div>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import {
      getDatabase, ref as dbRef, onValue, push, set, get, update, remove
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
    import {
      getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhz1XHoprhhrHyYfuAdIYGMJxm5UsDO-4",
      authDomain: "the-pic-c437e.firebaseapp.com",
      databaseURL: "https://the-pic-c437e-default-rtdb.firebaseio.com",
      projectId: "the-pic-c437e",
      storageBucket: "the-pic-c437e.appspot.com",
      messagingSenderId: "750954597180",
      appId: "1:750954597180:web:fc586d73d852ed5e17ec39"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    const adminsRef = dbRef(db, 'admins');
    const turnosRef = dbRef(db, 'turnos');
    const siteRef = dbRef(db, 'site');

    // Elementos UI
    const loginScreen = document.getElementById('loginScreen');
    const panel = document.getElementById('panel');
    const btnLogin = document.getElementById('btnLogin');
    const loginSpinner = document.getElementById('loginSpinner');
    const adminEmailInp = document.getElementById('adminEmail');
    const adminPassInp = document.getElementById('adminPass');
    const loginMsg = document.getElementById('loginMsg');
    const whoami = document.getElementById('whoami');
    const btnLogout = document.getElementById('btnLogout');
    const info = document.getElementById('info');
    const addBtn = document.getElementById('addBtn');
    const addSpinner = document.getElementById('addSpinner');
    const turnosList = document.getElementById('turnosList');
    const messageArea = document.getElementById('messageArea');

    // Inputs del formulario
    const fechaInput = document.getElementById('fecha');
    const horaInput = document.getElementById('hora');
    const precioInput = document.getElementById('precio');
    const ubicacionInput = document.getElementById('ubicacion');
    const latitudInput = document.getElementById('latitud');
    const longitudInput = document.getElementById('longitud');
    const descripcionInput = document.getElementById('descripcion');
    const photosInput = document.getElementById('photos');

    // Logo y promoci√≥n
    const logoFile = document.getElementById('logoFile');
    const uploadLogoBtn = document.getElementById('uploadLogoBtn');
    const logoPreview = document.getElementById('logoPreview');
    const promoFile = document.getElementById('promoFile');
    const uploadPromoBtn = document.getElementById('uploadPromoBtn');
    const promoPreview = document.getElementById('promoPreview');
    const deletePromoBtn = document.getElementById('deletePromoBtn');

    // Progress bars
    const promoProgressWrap = document.getElementById('promoProgressWrap');
    const promoProgressBar = document.getElementById('promoProgressBar');
    const promoProgressText = document.getElementById('promoProgressText');
    const turnoProgressWrap = document.getElementById('turnoProgressWrap');
    const turnoProgressBar = document.getElementById('turnoProgressBar');
    const turnoProgressText = document.getElementById('turnoProgressText');

    let currentAdminEmail = null;
    let allTurnos = {};

    // Funci√≥n para mostrar mensajes mejorada
    function showMessage(text, type='success', timeout=4000){
      messageArea.innerHTML = '';
      const d = document.createElement('div');
      d.className = 'msg ' + (type === 'success' ? 'success' : 'error');
      d.textContent = text;
      messageArea.appendChild(d);
      setTimeout(()=> { if(messageArea.contains(d)) messageArea.removeChild(d); }, timeout);
    }

    // Funci√≥n de login mejorada
    async function attemptLogin(email, password){
      try{
        loginSpinner.style.display = 'inline-block';
        btnLogin.disabled = true;
        loginMsg.textContent = 'Verificando credenciales...';
        
        const snap = await get(adminsRef);
        const admins = snap.val() || {};
        let found = false;
        
        for(const k of Object.keys(admins)){
          const a = admins[k];
          if(a.email === email && (a.password === password)){
            found = true;
            break;
          }
        }
        
        if(found){
          currentAdminEmail = email;
          sessionStorage.setItem('adminEmail', email);
          renderPanelForAdmin();
          showMessage('¬°Bienvenido al panel de administraci√≥n!', 'success');
        } else {
          loginMsg.textContent = 'Credenciales incorrectas';
          setTimeout(()=> loginMsg.textContent = '', 3000);
        }
      } catch(err){
        console.error(err);
        loginMsg.textContent = 'Error de conexi√≥n. Intenta nuevamente.';
        setTimeout(()=> loginMsg.textContent = '', 3000);
      } finally {
        loginSpinner.style.display = 'none';
        btnLogin.disabled = false;
      }
    }

    btnLogin.addEventListener('click', (e) => {
      const email = adminEmailInp.value.trim();
      const pass = adminPassInp.value;
      if(!email || !pass){ 
        loginMsg.textContent = 'Complet√° email y contrase√±a'; 
        return; 
      }
      attemptLogin(email, pass);
    });

    // Enter key para login
    adminPassInp.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        btnLogin.click();
      }
    });

    function renderPanelForAdmin(){
      loginScreen.style.display = 'none';
      panel.style.display = 'block';
      whoami.textContent = currentAdminEmail;
      info.textContent = 'Panel administrativo activo';
    }

    btnLogout.addEventListener('click', () => {
      sessionStorage.removeItem('adminEmail');
      currentAdminEmail = null;
      loginScreen.style.display = 'block';
      panel.style.display = 'none';
      info.textContent = 'Sesi√≥n cerrada';
      showMessage('Sesi√≥n cerrada correctamente', 'success');
    });

    // Verificar sesi√≥n guardada
    const saved = sessionStorage.getItem('adminEmail');
    if(saved){
      currentAdminEmail = saved;
      renderPanelForAdmin();
    }

    // Subida de logo mejorada
    uploadLogoBtn.addEventListener('click', async () => {
      const file = logoFile.files[0];
      if(!file){ 
        showMessage('Selecciona un archivo de imagen para el logo', 'error'); 
        return; 
      }
      
      try{
        uploadLogoBtn.disabled = true;
        uploadLogoBtn.innerHTML = '<span class="loading"></span> Subiendo...';
        
        const timestamp = Date.now();
        const path = 'site/logo_' + timestamp + '_' + file.name;
        const sRef = storageRef(storage, path);
        const uploadTask = uploadBytesResumable(sRef, file);
        
        promoProgressWrap.style.display = 'block';
        promoProgressBar.style.width = '0%';
        promoProgressText.style.display = 'block';
        promoProgressText.textContent = 'Subiendo logo... 0%';
        
        uploadTask.on('state_changed', (snapshot) => {
          const pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
          promoProgressBar.style.width = pct + '%';
          promoProgressText.textContent = 'Subiendo logo... ' + pct + '%';
        }, (err) => {
          console.error(err);
          showMessage('Error al subir el logo', 'error');
          promoProgressWrap.style.display = 'none';
          promoProgressText.style.display = 'none';
        }, async () => {
          const url = await getDownloadURL(uploadTask.snapshot.ref);
          await update(siteRef, { logoUrl: url });
          logoPreview.innerHTML = `<img src="${url}" alt="Logo" style="height:64px;width:auto;border-radius:12px;border:2px solid var(--success);">`;
          promoProgressWrap.style.display = 'none';
          promoProgressText.style.display = 'none';
          showMessage('Logo subido y actualizado correctamente', 'success');
        });
      } catch(err){
        console.error(err);
        showMessage('Error al procesar el logo', 'error');
      } finally {
        uploadLogoBtn.disabled = false;
        uploadLogoBtn.innerHTML = 'Subir Logo';
      }
    });

    // Subida de promoci√≥n mejorada
    uploadPromoBtn.addEventListener('click', async () => {
      const file = promoFile.files[0];
      if(!file){ 
        showMessage('Selecciona una imagen de promoci√≥n', 'error'); 
        return; 
      }
      
      try{
        uploadPromoBtn.disabled = true;
        uploadPromoBtn.innerHTML = '<span class="loading"></span> Subiendo...';
        
        promoProgressWrap.style.display = 'block';
        promoProgressBar.style.width = '0%';
        promoProgressText.style.display = 'block';
        promoProgressText.textContent = 'Subiendo promoci√≥n... 0%';

        const path = 'site/promo_' + Date.now() + '_' + file.name;
        const sRef = storageRef(storage, path);
        const uploadTask = uploadBytesResumable(sRef, file);
        
        uploadTask.on('state_changed', (snapshot) => {
          const pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
          promoProgressBar.style.width = pct + '%';
          promoProgressText.textContent = 'Subiendo promoci√≥n... ' + pct + '%';
        }, (err) => {
          console.error(err);
          showMessage('Error al subir la promoci√≥n', 'error');
          uploadPromoBtn.disabled = false;
          uploadPromoBtn.innerHTML = 'Subir Promoci√≥n';
          promoProgressWrap.style.display = 'none';
          promoProgressText.style.display = 'none';
        }, async () => {
          const url = await getDownloadURL(uploadTask.snapshot.ref);
          await update(siteRef, { promocion: { imageUrl: url, createdAt: Date.now() } });
          promoPreview.innerHTML = `<img src="${url}" alt="Promoci√≥n" style="height:80px;width:120px;border-radius:12px;border:2px solid var(--warning);">`;
          promoProgressWrap.style.display = 'none';
          promoProgressText.style.display = 'none';
          uploadPromoBtn.disabled = false;
          uploadPromoBtn.innerHTML = 'Subir Promoci√≥n';
          showMessage('Promoci√≥n subida correctamente', 'success');
        });
      } catch(err){
        console.error(err);
        uploadPromoBtn.disabled = false;
        uploadPromoBtn.innerHTML = 'Subir Promoci√≥n';
        promoProgressWrap.style.display = 'none';
        promoProgressText.style.display = 'none';
        showMessage('Error al procesar la promoci√≥n', 'error');
      }
    });

    // Eliminar promoci√≥n
    deletePromoBtn.addEventListener('click', async () => {
      if(!confirm('¬øEst√°s seguro de eliminar la promoci√≥n actual?')) return;
      
      try{
        await update(siteRef, { promocion: null });
        promoPreview.innerHTML = '';
        showMessage('Promoci√≥n eliminada correctamente', 'success');
      } catch(err){
        console.error(err);
        showMessage('Error al eliminar la promoci√≥n', 'error');
      }
    });

    // Agregar turno mejorado con GPS
    addBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      if(addBtn.disabled) return;
      
      try{
        const fecha = fechaInput.value;
        const hora = horaInput.value;
        const precio = Number(precioInput.value);
        const descripcion = descripcionInput.value.trim();
        const ubicacion = ubicacionInput.value.trim();
        const latitud = latitudInput.value ? Number(latitudInput.value) : null;
        const longitud = longitudInput.value ? Number(longitudInput.value) : null;
        
        if(!fecha || !hora || isNaN(precio)){
          showMessage('Complet√° fecha, hora y precio correctamente.', 'error'); 
          return;
        }

        // Deshabilitar UI
        addBtn.disabled = true;
        addSpinner.style.display = 'inline-block';
        fechaInput.disabled = true;
        horaInput.disabled = true;
        precioInput.disabled = true;
        ubicacionInput.disabled = true;
        latitudInput.disabled = true;
        longitudInput.disabled = true;
        descripcionInput.disabled = true;
        photosInput.disabled = true;

        // Mostrar progreso
        turnoProgressWrap.style.display = 'block';
        turnoProgressBar.style.width = '0%';
        turnoProgressText.style.display = 'block';
        turnoProgressText.textContent = 'Preparando turno... 0%';

        // Crear referencia
        const newRef = push(turnosRef);
        const id = newRef.key;

        const files = Array.from(photosInput.files || []);
        let uploadedUrls = [];

        if(files.length){
          const totalBytes = files.reduce((s,f)=> s+f.size, 0);
          let cumulativeTransferred = 0;

          for(const file of files){
            const path = 'turnos/' + id + '/' + Date.now() + '_' + file.name;
            const sRef = storageRef(storage, path);
            const uploadTask = uploadBytesResumable(sRef, file);

            await new Promise((resolve, reject) => {
              uploadTask.on('state_changed', snapshot => {
                const bytesTransferred = snapshot.bytesTransferred;
                const pct = Math.round(((cumulativeTransferred + bytesTransferred) / totalBytes) * 100);
                turnoProgressBar.style.width = pct + '%';
                turnoProgressText.textContent = 'Subiendo im√°genes... ' + pct + '%';
              }, (err) => {
                console.error(err);
                reject(err);
              }, async () => {
                const url = await getDownloadURL(uploadTask.snapshot.ref);
                uploadedUrls.push(url);
                cumulativeTransferred += file.size;
                resolve();
              });
            });
          }
        } else {
          turnoProgressBar.style.width = '80%';
          turnoProgressText.textContent = 'Guardando turno...';
        }

        // Guardar en DB con coordenadas GPS
        const turnoData = {
          fecha,
          hora,
          precio,
          descripcion,
          ubicacion,
          imagenes: uploadedUrls,
          reservadoPor: "",
          telefono: "",
          telefonoWhatsapp: "",
          emailCliente: "",
          estado: "disponible"
        };

        // Agregar coordenadas si est√°n disponibles
        if (latitud && longitud) {
          turnoData.lat = latitud;
          turnoData.lng = longitud;
        }

        await set(newRef, turnoData);

        // Finalizar progreso
        turnoProgressBar.style.width = '100%';
        turnoProgressText.textContent = '‚úÖ Turno agregado correctamente';
        
        setTimeout(() => {
          turnoProgressWrap.style.display = 'none';
          turnoProgressText.style.display = 'none';
        }, 1200);

        // Reset form
        fechaInput.value=''; 
        horaInput.value=''; 
        precioInput.value=''; 
        descripcionInput.value=''; 
        ubicacionInput.value=''; 
        latitudInput.value='';
        longitudInput.value='';
        photosInput.value='';

        showMessage('¬°Turno creado exitosamente!', 'success');
      } catch(err){
        console.error(err);
        showMessage('Error al crear el turno. Intenta nuevamente.', 'error');
      } finally {
        // Re-habilitar UI
        addBtn.disabled = false;
        addSpinner.style.display = 'none';
        fechaInput.disabled = false;
        horaInput.disabled = false;
        precioInput.disabled = false;
        ubicacionInput.disabled = false;
        latitudInput.disabled = false;
        longitudInput.disabled = false;
        descripcionInput.disabled = false;
        photosInput.disabled = false;
      }
    });

    // Funci√≥n para crear elemento de turno mejorado
    function crearTurnoElemento(id, data){
      const wrapper = document.createElement('div');
      wrapper.className = 'turno';
      
      const left = document.createElement('div');
      left.className = 'left';

      // Secci√≥n de im√°genes
      const imgBox = document.createElement('div');
      const imagesRow = document.createElement('div');
      imagesRow.className = 'images';
      
      if(Array.isArray(data.imagenes) && data.imagenes.length){
        data.imagenes.forEach(url => {
          const img = document.createElement('img');
          img.src = url; 
          img.alt = 'Imagen del turno';
          img.onclick = () => window.open(url, '_blank');
          imagesRow.appendChild(img);
        });
      } else {
        const placeholder = document.createElement('div');
        placeholder.style.cssText = `
          width:80px; height:80px; border-radius:12px; 
          background:#f1f5f9; display:flex; align-items:center; 
          justify-content:center; color:var(--muted); font-size:0.8rem;
          border:2px dashed var(--border);
        `;
        placeholder.textContent = 'Sin fotos';
        imagesRow.appendChild(placeholder);
      }
      imgBox.appendChild(imagesRow);

      // Informaci√≥n del turno
      const meta = document.createElement('div');
      meta.className = 'meta';
      
      // Construir informaci√≥n de ubicaci√≥n
      let locationInfo = data.ubicacion || 'Ubicaci√≥n no especificada';
      if (data.lat && data.lng) {
        locationInfo += ` (GPS: ${data.lat.toFixed(4)}, ${data.lng.toFixed(4)})`;
      }
      
      meta.innerHTML = `
        <div><strong>${data.fecha || 'Sin fecha'}</strong> 
        <span class="muted">‚Ä¢ ${data.hora || 'Sin hora'}</span></div>
        <div class="muted">üí∞ Precio: $${Number(data.precio||0).toLocaleString('es-AR')}</div>
        <div class="muted">üìç ${locationInfo}</div>
        <div style="margin-top:12px;line-height:1.4;">${data.descripcion || 'Sin descripci√≥n'}</div>
      `;

      // Estado del turno
      const estado = document.createElement('div');
      if(data.estado === 'reservado'){
        const phoneVisible = data.telefono || data.telefonoWhatsapp || 'No especificado';
        estado.innerHTML = `
          <div class="status-res">üîí Reservado</div>
          <div class="muted" style="margin-top:8px;">
            <strong>Cliente:</strong> ${data.reservadoPor || 'No especificado'}<br>
            <strong>Tel√©fono:</strong> ${phoneVisible}<br>
            <strong>Email:</strong> ${data.emailCliente || 'No especificado'}
          </div>
        `;
      } else {
        estado.innerHTML = `<div class="status-ava">‚úÖ Disponible</div>`;
      }

      left.appendChild(imgBox);
      left.appendChild(meta);

      // Acciones
      const actions = document.createElement('div');
      actions.className = 'actions';

      const btnEdit = document.createElement('button');
      btnEdit.className = 'btn-edit'; 
      btnEdit.textContent = '‚úèÔ∏è Editar';
      btnEdit.onclick = () => enableEditMode(wrapper, id, data);

      const btnDelete = document.createElement('button');
      btnDelete.className = 'btn-delete'; 
      btnDelete.textContent = 'üóëÔ∏è Eliminar';
      btnDelete.onclick = async () => {
        if(!confirm('¬øEliminar este turno permanentemente?')) return;
        try{
          await remove(dbRef(db, 'turnos/' + id));
          showMessage('Turno eliminado correctamente', 'success');
        }catch(err){ 
          console.error(err); 
          showMessage('Error al eliminar el turno', 'error'); 
        }
      };

      actions.appendChild(btnEdit);
      actions.appendChild(btnDelete);

      wrapper.appendChild(left);
      wrapper.appendChild(estado);
      wrapper.appendChild(actions);
      
      return wrapper;
    }

    // Funci√≥n para modo edici√≥n (mejorada con GPS)
    function enableEditMode(wrapper, id, data){
      wrapper.innerHTML = '';
      const editDiv = document.createElement('div');
      editDiv.style.cssText = `
        display:grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap:12px;
        align-items:center;
        padding:20px;
        background:rgba(68,13,19,0.05);
        border-radius:12px;
      `;

      const fechaInp = document.createElement('input'); 
      fechaInp.type='date'; 
      fechaInp.value = data.fecha || '';
      
      const horaInp = document.createElement('input'); 
      horaInp.type='time'; 
      horaInp.value = data.hora || '';
      
      const precioInp = document.createElement('input'); 
      precioInp.type='number'; 
      precioInp.value = data.precio || '';
      
      const ubicInp = document.createElement('input'); 
      ubicInp.type='text'; 
      ubicInp.value = data.ubicacion || '';
      ubicInp.placeholder = 'Ubicaci√≥n';
      
      const latInp = document.createElement('input');
      latInp.type='number';
      latInp.step='any';
      latInp.value = data.lat || '';
      latInp.placeholder = 'Latitud';
      
      const lngInp = document.createElement('input');
      lngInp.type='number';
      lngInp.step='any';
      lngInp.value = data.lng || '';
      lngInp.placeholder = 'Longitud';
      
      const descInp = document.createElement('textarea'); 
      descInp.value = data.descripcion || '';
      descInp.placeholder = 'Descripci√≥n';
      descInp.style.cssText = 'grid-column: 1 / -1; border-radius:8px; min-height:60px;';

      const estadoSel = document.createElement('select');
      const o1 = document.createElement('option'); o1.value='disponible'; o1.textContent='‚úÖ Disponible';
      const o2 = document.createElement('option'); o2.value='reservado'; o2.textContent='üîí Reservado';
      estadoSel.appendChild(o1); estadoSel.appendChild(o2);
      estadoSel.value = data.estado || 'disponible';

      const reservadoInp = document.createElement('input'); 
      reservadoInp.type='text'; 
      reservadoInp.placeholder='Cliente'; 
      reservadoInp.value = data.reservadoPor || '';
      
      const telInp = document.createElement('input'); 
      telInp.type='text'; 
      telInp.placeholder='Tel√©fono'; 
      telInp.value = data.telefono || data.telefonoWhatsapp || '';
      
      const mailInp = document.createElement('input'); 
      mailInp.type='email'; 
      mailInp.placeholder='Email'; 
      mailInp.value = data.emailCliente || '';

      const photosEdit = document.createElement('input'); 
      photosEdit.type='file'; 
      photosEdit.multiple=true; 
      photosEdit.accept='image/*';
      photosEdit.style.cssText = 'grid-column: 1 / -1;';

      const btnSave = document.createElement('button'); 
      btnSave.className='btn'; 
      btnSave.textContent='üíæ Guardar Cambios';
      btnSave.onclick = async () => {
        try{
          const nuevaFecha = fechaInp.value; 
          const nuevaHora = horaInp.value;
          const nuevoPrecio = Number(precioInp.value);
          
          if(!nuevaFecha || !nuevaHora || isNaN(nuevoPrecio)){ 
            showMessage('Completa fecha, hora y precio','error'); 
            return; 
          }
          
          btnSave.disabled = true;
          btnSave.innerHTML = '<span class="loading"></span> Guardando...';
          
          // Subir nuevas im√°genes si las hay
          const newFiles = Array.from(photosEdit.files || []);
          const urls = Array.isArray(data.imagenes) ? [...data.imagenes] : [];
          
          if(newFiles.length){
            for(const f of newFiles){
              const path = 'turnos/' + id + '/' + Date.now() + '_' + f.name;
              const sRef = storageRef(storage, path);
              const uploadTask = uploadBytesResumable(sRef, f);
              
              await new Promise((res, rej) => {
                uploadTask.on('state_changed', ()=>{}, (err)=> rej(err), async ()=> {
                  const url = await getDownloadURL(uploadTask.snapshot.ref);
                  urls.push(url);
                  res();
                });
              });
            }
          }
          
          // Preparar datos actualizados
          const updateData = {
            fecha: nuevaFecha, 
            hora: nuevaHora, 
            precio: nuevoPrecio,
            descripcion: descInp.value, 
            ubicacion: ubicInp.value,
            imagenes: urls,
            estado: estadoSel.value,
            reservadoPor: estadoSel.value === 'reservado' ? reservadoInp.value : '',
            telefono: estadoSel.value === 'reservado' ? telInp.value : '',
            telefonoWhatsapp: estadoSel.value === 'reservado' ? telInp.value : '',
            emailCliente: estadoSel.value === 'reservado' ? mailInp.value : ''
          };
          
          // Agregar coordenadas GPS si est√°n disponibles
          if (latInp.value && lngInp.value) {
            updateData.lat = Number(latInp.value);
            updateData.lng = Number(lngInp.value);
          }
          
          await update(dbRef(db, 'turnos/' + id), updateData);
          showMessage('Turno actualizado correctamente', 'success');
        } catch(err){ 
          console.error(err); 
          showMessage('Error al actualizar el turno','error'); 
        } finally {
          btnSave.disabled = false;
          btnSave.textContent = 'üíæ Guardar Cambios';
        }
      };

      const btnCancel = document.createElement('button'); 
      btnCancel.className='btn-edit'; 
      btnCancel.textContent='‚ùå Cancelar';
      btnCancel.onclick = () => {
        // El listener de Firebase re-renderizar√° autom√°ticamente
      };

      editDiv.appendChild(fechaInp); 
      editDiv.appendChild(horaInp); 
      editDiv.appendChild(precioInp);
      editDiv.appendChild(ubicInp);
      editDiv.appendChild(latInp);
      editDiv.appendChild(lngInp);
      editDiv.appendChild(descInp);
      editDiv.appendChild(estadoSel); 
      editDiv.appendChild(reservadoInp); 
      editDiv.appendChild(telInp); 
      editDiv.appendChild(mailInp);
      editDiv.appendChild(photosEdit); 
      editDiv.appendChild(btnSave); 
      editDiv.appendChild(btnCancel);

      wrapper.appendChild(editDiv);
    }

    // Escuchar cambios en turnos
    onValue(turnosRef, (snapshot) => {
      allTurnos = snapshot.val() || {};
      renderTurnosList();
    }, (err) => {
      console.error(err);
      info.textContent = 'Error de conexi√≥n a la base de datos';
      showMessage('Error de conexi√≥n. Verifica tu internet.', 'error');
    });

    // Escuchar cambios en configuraci√≥n del sitio
    onValue(siteRef, (snap) => {
      const s = snap.val() || {};
      logoPreview.innerHTML = '';
      promoPreview.innerHTML = '';
      
      if(s.logoUrl){ 
        logoPreview.innerHTML = `<img src="${s.logoUrl}" alt="Logo" style="height:64px;width:auto;border-radius:12px;border:2px solid var(--success);">`;
      }
      
      if(s.promocion && s.promocion.imageUrl){ 
        promoPreview.innerHTML = `<img src="${s.promocion.imageUrl}" alt="Promoci√≥n" style="height:80px;width:120px;border-radius:12px;border:2px solid var(--warning);">`;
      }
    });

    // Renderizar lista de turnos
    function renderTurnosList(){
      const keys = Object.keys(allTurnos).sort((a,b) => {
        const A = (allTurnos[a].fecha || '') + ' ' + (allTurnos[a].hora || '');
        const B = (allTurnos[b].fecha || '') + ' ' + (allTurnos[b].hora || '');
        return A.localeCompare(B);
      });
      
      turnosList.innerHTML = '';
      
      if(keys.length === 0) { 
        turnosList.innerHTML = `
          <div style="text-align:center;padding:60px 20px;color:var(--muted);">
            <div style="font-size:4rem;margin-bottom:20px;">üìã</div>
            <div style="font-size:1.2rem;margin-bottom:8px;">No hay turnos registrados</div>
            <div style="font-size:0.9rem;">Agrega el primer turno usando el formulario de arriba</div>
          </div>
        `; 
        return; 
      }
      
      keys.forEach((id, index) => {
        const el = crearTurnoElemento(id, allTurnos[id]);
        el.style.animationDelay = `${index * 0.1}s`;
        turnosList.appendChild(el);
      });
    }

  </script>
</body>
</html>