<!doctype html>
<html lang="es">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Fuentes profesionales y elegantes -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Manrope:wght@200;300;400;500;600;700;800&family=Geist:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reservá tu Turno — Estética Profesional</title>
  <style>
    /* Franja superior animada - mejorada */
    .promo-bar {
      width: 100vw;
      min-width: 100%;
      background: linear-gradient(135deg, #440D13 0%, #5a1119 50%, #440D13 100%);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 0;
      overflow: hidden;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 200;
      height: 42px;
      display: flex;
      align-items: center;
      box-sizing: border-box;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 20px rgba(68, 13, 19, 0.3);
    }
    .promo-bar-text {
      color: #ffffff;
      font-family: 'Geist', sans-serif;
      font-size: 1.1rem;
      font-weight: 500;
      white-space: nowrap;
      display: inline-block;
      animation: promoScroll 15s linear infinite;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    @keyframes promoScroll {
      0% { transform: translateX(100vw); }
      100% { transform: translateX(-100vw); }
    }

    /* Hero section mejorada */
    .hero-section {
      background: linear-gradient(135deg, #E8E6DA 0%, #f4f2e8 50%, #E8E6DA 100%);
      padding: 80px 0 60px 0;
      margin-top: 42px;
      position: relative;
      overflow: hidden;
    }
    .hero-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="1" fill="%23440D13" opacity="0.05"/><circle cx="80" cy="80" r="1" fill="%23440D13" opacity="0.05"/><circle cx="40" cy="60" r="0.5" fill="%23440D13" opacity="0.03"/></svg>');
      animation: floatPattern 20s ease-in-out infinite;
    }
    @keyframes floatPattern {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    .hero-content {
      position: relative;
      z-index: 10;
      animation: fadeInUp 0.8s ease-out;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    :root{
      --bg: #E8E6DA;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #440D13;
      --accent-strong: #ffffff;
      --text-main: #111827;
      --text-secondary: #4b5563;
      --border: #e5e7eb;
      --shadow: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-hover: 0 8px 32px rgba(68, 13, 19, 0.15);
      --radius: 16px;
      --header-height: 80px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: 'Geist', 'Inter', system-ui, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      min-height: 100vh;
      color: var(--text-main);
      font-family: 'Geist', system-ui, sans-serif;
      font-weight: 400;
      line-height: 1.6;
      transition: var(--transition);
      overflow-x: hidden;
    }

    .wrap {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
    }

    /* Header mejorado */
    header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 32px 0;
      position: relative;
      z-index: 100;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 20px;
      justify-content: center;
      text-align: center;
    }

    .brand img {
      height: 64px;
      width: auto;
      border-radius: 12px;
      transition: var(--transition);
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
    }

    .brand img:hover {
      transform: scale(1.05);
      filter: drop-shadow(0 8px 16px rgba(0,0,0,0.15));
    }

    h1 {
      margin: 0;
      font-size: 3.2rem;
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 700;
      color: var(--text-main);
      letter-spacing: -0.02em;
      line-height: 1.1;
    }

    p.lead {
      margin: 8px 0 0 0;
      color: var(--text-secondary);
      font-size: 1.2rem;
      font-family: 'Manrope', sans-serif;
      font-weight: 400;
    }

    /* Controles mejorados */
    .controls {
      display: flex;
      gap: 20px;
      align-items: center;
      justify-content: center;
      margin: 40px 0;
      flex-wrap: wrap;
      padding: 24px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      animation: slideInDown 0.6s ease-out 0.2s both;
    }

    @keyframes slideInDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    input[type="search"], select {
      padding: 12px 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: white;
      color: var(--text-main);
      font-size: 1rem;
      font-family: 'Manrope', sans-serif;
      font-weight: 500;
      transition: var(--transition);
      outline: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    input[type="search"]:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(68, 13, 19, 0.1);
      transform: translateY(-1px);
    }

    .tabs {
      display: flex;
      gap: 12px;
    }

    .tab {
      padding: 12px 24px;
      border-radius: 12px;
      background: white;
      border: 1px solid var(--border);
      cursor: pointer;
      color: var(--text-main);
      font-weight: 600;
      font-family: 'Manrope', sans-serif;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .tab::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transition: left 0.5s ease;
    }

    .tab:hover::before {
      left: 100%;
    }

    .tab.active, .tab:hover {
      border-color: var(--accent);
      color: white;
      background: var(--accent);
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    /* Grid mejorado */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 32px;
      justify-items: center;
      padding: 0;
      animation: fadeIn 0.8s ease-out 0.4s both;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Tarjetas completamente rediseñadas */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 24px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
      max-width: 380px;
      min-height: 420px;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      animation: cardFadeIn 0.6s ease-out both;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), #5a1119);
      opacity: 0;
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-8px);
      box-shadow: var(--shadow-hover);
    }

    .card:hover::before {
      opacity: 1;
    }

    @keyframes cardFadeIn {
      from { 
        opacity: 0; 
        transform: translateY(20px) scale(0.95);
      }
      to { 
        opacity: 1; 
        transform: translateY(0) scale(1);
      }
    }

    /* Carrusel de imágenes */
    .image-carousel {
      position: relative;
      width: 100%;
      height: 200px;
      border-radius: 12px;
      overflow: hidden;
      background: #f8f9fa;
    }

    .carousel-container {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .carousel-slide {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }

    .carousel-slide.active {
      opacity: 1;
    }

    .carousel-slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: var(--transition);
    }

    .carousel-slide img:hover {
      transform: scale(1.05);
    }

    .carousel-nav {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
    }

    .carousel-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      transition: var(--transition);
    }

    .carousel-dot.active {
      background: white;
      transform: scale(1.2);
    }

    /* Meta información */
    .meta {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex-grow: 1;
    }

    .meta-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
    }

    .meta-date {
      font-weight: 700;
      font-size: 1.3rem;
      color: var(--text-main);
      font-family: 'Space Grotesk', sans-serif;
    }

    .meta-time {
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: 500;
      font-family: 'Manrope', sans-serif;
    }

    .price {
      font-weight: 800;
      color: var(--accent);
      font-size: 1.4rem;
      font-family: 'Space Grotesk', sans-serif;
      text-align: right;
    }

    .location-info {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-family: 'Manrope', sans-serif;
    }

    /* Descripción mejorada */
    .description {
      text-align: left;
      color: var(--text-secondary);
      font-size: 0.95rem;
      line-height: 1.5;
      font-family: 'Manrope', sans-serif;
      position: relative;
    }

    .description.collapsed {
      max-height: 60px;
      overflow: hidden;
      position: relative;
    }

    .description.collapsed::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 20px;
      background: linear-gradient(transparent, white);
    }

    .description.expanded {
      max-height: none;
    }

    .show-more-btn {
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      font-family: 'Manrope', sans-serif;
      margin-top: 8px;
      padding: 4px 0;
      transition: var(--transition);
    }

    .show-more-btn:hover {
      color: #5a1119;
      transform: translateX(4px);
    }

    /* Botones mejorados */
    button {
      border: 0;
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      font-family: 'Manrope', sans-serif;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn-reservar {
      background: var(--accent);
      color: white;
      border: 2px solid var(--accent);
      min-width: 140px;
    }

    .btn-reservar::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s ease;
    }

    .btn-reservar:hover::before {
      left: 100%;
    }

    .btn-reservar:hover {
      background: #5a1119;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(68, 13, 19, 0.3);
    }

    .btn-maps {
      background: white;
      color: var(--accent);
      border: 1px solid var(--border);
      font-size: 0.9rem;
      padding: 8px 16px;
      margin-top: 8px;
    }

    .btn-maps:hover {
      background: var(--accent);
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(68, 13, 19, 0.2);
    }

    .btn-disabled {
      background: #f9fafb;
      color: #9ca3af;
      cursor: not-allowed;
      border: 1px solid #e5e7eb;
    }

    /* Status mejorado */
    .status-available {
      color: #059669;
      font-weight: 700;
      font-family: 'Space Grotesk', sans-serif;
    }

    .status-reserved {
      color: var(--muted);
      font-weight: 700;
      font-family: 'Space Grotesk', sans-serif;
    }

    .card-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-top: auto;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    /* Footer mejorado */
    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 60px;
      padding: 32px 0;
      border-top: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
    }

    /* Mensajes */
    .msg {
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 1rem;
      font-family: 'Manrope', sans-serif;
      font-weight: 500;
      animation: slideInUp 0.4s ease-out;
    }

    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .msg.success {
      background: #f0fdf4;
      color: #059669;
      border: 1px solid #bbf7d0;
    }

    .msg.error {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    /* Modales mejorados */
    .resBackdrop {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 220;
      visibility: hidden;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .resBackdrop.show {
      visibility: visible;
      opacity: 1;
    }

    .resModal {
      background: var(--card);
      border-radius: 20px;
      padding: 32px;
      width: 100%;
      max-width: 480px;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.3);
      color: var(--text-main);
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .resBackdrop.show .resModal {
      transform: scale(1);
    }

    .resModal h3 {
      margin: 0 0 24px 0;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.8rem;
      font-weight: 700;
    }

    .resForm {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .resForm input {
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 1rem;
      font-family: 'Manrope', sans-serif;
      transition: var(--transition);
    }

    .resForm input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(68, 13, 19, 0.1);
    }

    /* Promoción modal mejorado */
    .promoBackdrop {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(68, 13, 19, 0.8);
      backdrop-filter: blur(12px);
      z-index: 120;
      visibility: hidden;
      opacity: 0;
      transition: all 0.4s ease;
    }

    .promoBackdrop.show {
      visibility: visible;
      opacity: 1;
    }

    .promoCard {
      background: var(--card);
      border-radius: 24px;
      padding: 24px;
      max-width: 90%;
      max-height: 85vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: 0 32px 80px rgba(0, 0, 0, 0.4);
      transform: scale(0.8);
      transition: transform 0.4s ease;
    }

    .promoBackdrop.show .promoCard {
      transform: scale(1);
    }

    /* FAB mejorado */
    .fab {
      position: fixed;
      right: 24px;
      bottom: 24px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 0;
      background: var(--accent);
      box-shadow: 0 8px 32px rgba(68, 13, 19, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 400;
      cursor: pointer;
      transition: var(--transition);
      animation: fabFloat 3s ease-in-out infinite;
    }

    @keyframes fabFloat {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-6px); }
    }

    .fab:hover {
      transform: scale(1.1) translateY(-4px);
      box-shadow: 0 12px 40px rgba(68, 13, 19, 0.5);
    }

    .fab img {
      width: 70%;
      height: 70%;
      object-fit: contain;
      border-radius: 50%;
    }

    /* Responsive mejorado */
    @media (max-width: 768px) {
      h1 {
        font-size: 2.4rem;
      }
      
      p.lead {
        font-size: 1.1rem;
      }

      .wrap {
        padding: 0 16px;
      }

      .grid {
        grid-template-columns: 1fr;
        gap: 24px;
      }

      .card {
        max-width: 100%;
        min-height: auto;
      }

      .controls {
        flex-direction: column;
        gap: 16px;
        padding: 20px;
      }

      .controls > div {
        width: 100%;
      }

      input[type="search"], select {
        width: 100%;
      }

      .tabs {
        width: 100%;
        justify-content: center;
      }

      .meta-header {
        flex-direction: column;
        gap: 8px;
      }

      .card-actions {
        flex-direction: column;
        gap: 12px;
      }

      .btn-reservar, .btn-maps {
        width: 100%;
      }

      .fab {
        width: 56px;
        height: 56px;
        right: 16px;
        bottom: 16px;
      }
    }

    @media (max-width: 480px) {
      .hero-section {
        padding: 60px 0 40px 0;
      }
      
      h1 {
        font-size: 2rem;
      }

      .card {
        padding: 20px;
      }

      .resModal {
        padding: 24px;
        margin: 16px;
      }
    }

  </style>
</head>
<body>
  <!-- Barra promocional mejorada -->
  <div class="promo-bar">
    <div class="promo-bar-text">
      ✨ Promoción especial: 50% OFF todos los jueves • Reservá tu turno ahora ✨ • 50% OFF todos los jueves • Reservá tu turno ahora ✨
    </div>
  </div>

  <!-- Hero section profesional -->
  <section class="hero-section">
    <div class="wrap">
      <header>
        <div class="brand">
          <img id="siteLogo" src="" alt="Logo" onerror="this.style.display='none'">
          <img id="receiptLogo" src="logo.png" alt="Logo comprobante" style="display:none;" onerror="this.style.display='none'">
          <div class="hero-content">
            <h1>Reservá tu turno</h1>
            <p class="lead">Elegí tu cita en la mejor estética profesional</p>
          </div>
        </div>
      </header>
    </div>
  </section>

  <div class="wrap">
    <!-- Controles mejorados -->
    <div class="controls">
      <div style="display:flex;gap:16px;align-items:center;width:100%;max-width:600px;">
        <input id="search" type="search" placeholder="Buscar por fecha, ubicación..." style="flex:1;">
        <select id="filterState">
          <option value="all">Todos los turnos</option>
          <option value="disponible">Solo disponibles</option>
          <option value="reservado">Solo reservados</option>
        </select>
      </div>
      <div class="tabs" role="tablist" aria-label="Filtros">
        <button class="tab active" data-tab="all">Todos</button>
      </div>
    </div>

    <!-- Grid de turnos -->
    <section id="turnosSection">
      <div id="turnosGrid" class="grid" aria-live="polite"></div>

      <div class="footer">
        <div id="messageArea"></div>
        <div style="color:var(--text-secondary);font-family:'Manrope',sans-serif;">
          Total de turnos: <span id="count" style="font-weight:600;color:var(--accent);">0</span>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal de reserva mejorado -->
  <div id="resBackdrop" class="resBackdrop" aria-hidden="true">
    <div class="resModal" role="dialog" aria-modal="true" aria-labelledby="resTitle">
      <h3 id="resTitle">Confirmar Reserva</h3>
      <form id="resForm" class="resForm">
        <input id="resName" type="text" placeholder="Nombre completo" required>
        <div style="display:flex;gap:12px;">
          <input id="resWhatsapp" type="text" placeholder="WhatsApp" required style="flex:1;">
          <input id="resEmail" type="email" placeholder="Email" style="flex:1;">
        </div>
        <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:24px;">
          <button type="button" id="resCancel" style="background:transparent;border:1px solid var(--border);color:var(--text-secondary);">Cancelar</button>
          <button type="submit" id="resSubmit" class="btn-reservar">Confirmar y descargar comprobante</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de promoción mejorado -->
  <div id="promoBackdrop" class="promoBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="promoCard">
      <button id="promoTop" style="position:absolute;left:50%;transform:translateX(-50%);top:-40px;background:transparent;border:0;color:white;font-size:32px;cursor:pointer;" title="Cerrar">˄</button>
      <button id="promoX" style="position:absolute;right:-20px;top:-10px;background:white;border-radius:50%;width:40px;height:40px;border:0;color:var(--accent);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;" title="Cerrar">✕</button>
      <img id="promoImg" src="" alt="Promoción" style="max-width:100%;max-height:100%;border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,0.2);">
    </div>
  </div>

  <!-- FAB mejorado -->
  <button id="fab" class="fab" data-href="http://wa.me/2235703012" aria-label="Contacto WhatsApp">
    <img id="fabImg" src="w.jpg" alt="WhatsApp" onerror="this.style.display='none'" />
  </button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getDatabase, ref as dbRef, onValue, get, update } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhz1XHoprhhrHyYfuAdIYGMJxm5UsDO-4",
      authDomain: "the-pic-c437e.firebaseapp.com",
      databaseURL: "https://the-pic-c437e-default-rtdb.firebaseio.com",
      projectId: "the-pic-c437e",
      storageBucket: "the-pic-c437e.appspot.com",
      messagingSenderId: "750954597180",
      appId: "1:750954597180:web:fc586d73d852ed5e17ec39"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const turnosRef = dbRef(db, 'turnos');
    const siteRef = dbRef(db, 'site');

    const grid = document.getElementById('turnosGrid');
    const countEl = document.getElementById('count');
    const msgArea = document.getElementById('messageArea');
    const searchInput = document.getElementById('search');
    const filterState = document.getElementById('filterState');
    const tabs = document.querySelectorAll('.tab');
    const siteLogoImg = document.getElementById('siteLogo');

    // Elementos de promoción
    const promoBackdrop = document.getElementById('promoBackdrop');
    const promoImg = document.getElementById('promoImg');
    const promoTop = document.getElementById('promoTop');
    const promoX = document.getElementById('promoX');

    // Elementos de reserva
    const resBackdrop = document.getElementById('resBackdrop');
    const resForm = document.getElementById('resForm');
    const resName = document.getElementById('resName');
    const resWhatsapp = document.getElementById('resWhatsapp');
    const resEmail = document.getElementById('resEmail');
    const resCancel = document.getElementById('resCancel');
    const resSubmit = document.getElementById('resSubmit');

    let allTurnos = {};
    let currentTab = 'all';
    let turnoToReserve = null;
    let lastTicketDataUrl = null;

    // Función para mostrar mensajes mejorada
    function showMessage(text, type='success', timeout=4000){
      msgArea.innerHTML = '';
      const d = document.createElement('div');
      d.className = 'msg ' + (type === 'success' ? 'success' : 'error');
      d.textContent = text;
      msgArea.appendChild(d);
      setTimeout(()=> { if(msgArea.contains(d)) msgArea.removeChild(d); }, timeout);
    }

    // Función para crear carrusel de imágenes
    function createImageCarousel(images) {
      if (!Array.isArray(images) || images.length === 0) {
        return `
          <div class="image-carousel">
            <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='400' height='200'><rect width='100%' height='100%' fill='%23f8f9fa'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%236b7280' font-family='Manrope' font-size='16'>Sin imágenes</text></svg>" alt="Sin imágenes" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">
          </div>
        `;
      }

      if (images.length === 1) {
        return `
          <div class="image-carousel">
            <img src="${images[0]}" alt="Imagen del turno" style="width:100%;height:100%;object-fit:cover;border-radius:12px;cursor:pointer;" onclick="openImageModal('${images[0]}')">
          </div>
        `;
      }

      const slides = images.map((img, index) => `
        <div class="carousel-slide ${index === 0 ? 'active' : ''}" data-slide="${index}">
          <img src="${img}" alt="Imagen ${index + 1}" onclick="openImageModal('${img}')">
        </div>
      `).join('');

      const dots = images.map((_, index) => `
        <div class="carousel-dot ${index === 0 ? 'active' : ''}" data-slide="${index}"></div>
      `).join('');

      return `
        <div class="image-carousel" data-carousel>
          <div class="carousel-container">
            ${slides}
          </div>
          <div class="carousel-nav">
            ${dots}
          </div>
        </div>
      `;
    }

    // Función para abrir imagen en modal
    function openImageModal(imageSrc) {
      promoImg.src = imageSrc;
      promoBackdrop.classList.add('show');
      promoBackdrop.setAttribute('aria-hidden', 'false');
    }

    // Función para truncar descripción
    function createDescription(text) {
      if (!text || text.length <= 150) {
        return `<div class="description">${text || 'Sin descripción disponible'}</div>`;
      }
      
      const shortText = text.substring(0, 150) + '...';
      return `
        <div class="description collapsed" data-full-text="${text.replace(/"/g, '&quot;')}">
          <div class="description-text">${shortText}</div>
          <button class="show-more-btn" onclick="toggleDescription(this)">Ver más</button>
        </div>
      `;
    }

    // Función para toggle de descripción
    window.toggleDescription = function(button) {
      const description = button.closest('.description');
      const textDiv = description.querySelector('.description-text');
      const fullText = description.getAttribute('data-full-text');
      
      if (description.classList.contains('collapsed')) {
        description.classList.remove('collapsed');
        description.classList.add('expanded');
        textDiv.textContent = fullText;
        button.textContent = 'Ver menos';
      } else {
        description.classList.remove('expanded');
        description.classList.add('collapsed');
        textDiv.textContent = fullText.substring(0, 150) + '...';
        button.textContent = 'Ver más';
      }
    };

    // Función para crear botón de Google Maps
    function createMapsButton(ubicacion, lat, lng) {
      if (!ubicacion && !lat && !lng) return '';
      
      let mapsUrl;
      if (lat && lng) {
        mapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
      } else {
        mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(ubicacion)}`;
      }
      
      return `<button class="btn-maps" onclick="window.open('${mapsUrl}', '_blank')">📍 Ver en Maps</button>`;
    }

    // Función para crear tarjeta mejorada
    function crearCard(id, data){
      const card = document.createElement('article');
      card.className = 'card';
      card.style.animationDelay = `${Math.random() * 0.3}s`;

      const estado = data.estado || 'disponible';
      const isAvailable = estado === 'disponible';

      card.innerHTML = `
        ${createImageCarousel(data.imagenes)}
        
        <div class="meta">
          <div class="meta-header">
            <div>
              <div class="meta-date">${data.fecha || 'Fecha no disponible'}</div>
              <div class="meta-time">${data.hora || 'Hora no disponible'}</div>
              ${data.ubicacion ? `<div class="location-info">📍 ${data.ubicacion}</div>` : ''}
            </div>
            <div class="price">$${Number(data.precio || 0).toLocaleString('es-AR')}</div>
          </div>
          
          ${createDescription(data.descripcion)}
          
          <div class="card-actions">
            <div class="${isAvailable ? 'status-available' : 'status-reserved'}">
              ${isAvailable ? '✅ Disponible' : '🔒 Reservado'}
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;">
              ${isAvailable ? 
                `<button class="btn-reservar" onclick="openReservationModal('${id}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">Reservar turno</button>` :
                `<button class="btn-disabled" disabled>No disponible</button>`
              }
              ${createMapsButton(data.ubicacion, data.lat, data.lng)}
            </div>
          </div>
        </div>
      `;

      // Inicializar carrusel si tiene múltiples imágenes
      setTimeout(() => initCarousel(card), 100);

      return card;
    }

    // Inicializar carrusel
    function initCarousel(cardElement) {
      const carousel = cardElement.querySelector('[data-carousel]');
      if (!carousel) return;

      const slides = carousel.querySelectorAll('.carousel-slide');
      const dots = carousel.querySelectorAll('.carousel-dot');
      
      if (slides.length <= 1) return;

      let currentSlide = 0;
      let intervalId;

      // Función para mostrar slide
      function showSlide(index) {
        slides.forEach((slide, i) => {
          slide.classList.toggle('active', i === index);
        });
        dots.forEach((dot, i) => {
          dot.classList.toggle('active', i === index);
        });
        currentSlide = index;
      }

      // Función para siguiente slide
      function nextSlide() {
        const next = (currentSlide + 1) % slides.length;
        showSlide(next);
      }

      // Auto-play
      function startAutoPlay() {
        intervalId = setInterval(nextSlide, 4000);
      }

      function stopAutoPlay() {
        clearInterval(intervalId);
      }

      // Event listeners para dots
      dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
          showSlide(index);
          stopAutoPlay();
          startAutoPlay(); // Reiniciar auto-play
        });
      });

      // Pause on hover
      carousel.addEventListener('mouseenter', stopAutoPlay);
      carousel.addEventListener('mouseleave', startAutoPlay);

      // Iniciar auto-play
      startAutoPlay();
    }

    // Función para abrir modal de reserva
    window.openReservationModal = function(id, data) {
      turnoToReserve = { id, data };
      resForm.reset();
      resBackdrop.classList.add('show');
      resBackdrop.setAttribute('aria-hidden', 'false');
      resName.focus();
    };

    function closeReservationModal(){
      resBackdrop.classList.remove('show');
      resBackdrop.setAttribute('aria-hidden', 'true');
      turnoToReserve = null;
    }

    // Event listeners para modal de reserva
    resCancel.addEventListener('click', () => {
      closeReservationModal();
      showMessage('Reserva cancelada', 'error');
    });

    resForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if(!turnoToReserve) { 
        showMessage('No se detectó el turno a reservar', 'error'); 
        closeReservationModal(); 
        return; 
      }
      
      const nombre = resName.value.trim();
      const whatsapp = resWhatsapp.value.trim().replace(/\D/g,'');
      const email = resEmail.value.trim();

      if(nombre.length < 3){ 
        showMessage('Ingresá tu nombre completo.', 'error'); 
        return; 
      }
      if(!/^\d{6,15}$/.test(whatsapp)){ 
        showMessage('Ingresá un número de WhatsApp válido (solo dígitos).', 'error'); 
        return; 
      }
      if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ 
        showMessage('Ingresá un correo válido.', 'error'); 
        return; 
      }

      resSubmit.disabled = true;

      try {
        const id = turnoToReserve.id;
        // Verificar estado actual
        const snap = await get(dbRef(db, 'turnos/' + id));
        if(!snap.exists()){
          showMessage('El turno ya no existe.', 'error');
          closeReservationModal();
          return;
        }
        
        const current = snap.val();
        if(current.estado === 'reservado'){
          showMessage('Ese turno ya fue reservado por otro usuario.', 'error');
          closeReservationModal();
          return;
        }

        // Actualizar DB
        await update(dbRef(db, 'turnos/' + id), {
          reservadoPor: nombre,
          telefonoWhatsapp: whatsapp,
          telefono: whatsapp,
          emailCliente: email,
          estado: 'reservado'
        });

        showMessage('¡Reserva confirmada! Generando comprobante...', 'success');

        // Generar y descargar comprobante
        const finalSnap = await get(dbRef(db, 'turnos/' + id));
        const finalData = finalSnap.val() || turnoToReserve.data;

        try {
          const ticketDataUrl = await generateTicketImage(finalData, { nombre, whatsapp, email });
          lastTicketDataUrl = ticketDataUrl;
          triggerDownload(ticketDataUrl, buildFileName(finalData));
          showDownloadHelper(ticketDataUrl);
        } catch(imgErr){
          console.error('Error generando comprobante:', imgErr);
          showMessage('Reserva confirmada — pero falló la generación del comprobante.', 'error');
        }

        closeReservationModal();
      } catch(err){
        console.error(err);
        showMessage('Error al reservar. Intenta nuevamente.', 'error');
      } finally {
        resSubmit.disabled = false;
      }
    });

    // Funciones para generar y descargar comprobante (mantenidas del original)
    function triggerDownload(dataUrl, filename){
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function buildFileName(turno){
      const safeDate = (turno.fecha || '').replace(/-/g,'');
      const safeTime = (turno.hora || '').replace(/:/g,'');
      return `comprobante_turno_${safeDate}_${safeTime}.png`;
    }

    function showDownloadHelper(dataUrl){
      const existing = document.getElementById('downloadTicketBtn');
      if(existing) existing.remove();
      
      const btn = document.createElement('button');
      btn.id = 'downloadTicketBtn';
      btn.style.cssText = `
        background: var(--accent); 
        color: white; 
        border: none; 
        padding: 12px 20px; 
        border-radius: 12px; 
        cursor: pointer; 
        font-family: 'Manrope', sans-serif; 
        font-weight: 600; 
        margin-top: 12px;
        transition: var(--transition);
      `;
      btn.innerHTML = '📥 Descargar comprobante nuevamente';
      btn.onclick = () => triggerDownload(dataUrl, 'comprobante.png');
      btn.addEventListener('mouseenter', () => {
        btn.style.transform = 'translateY(-2px)';
        btn.style.boxShadow = '0 8px 24px rgba(68, 13, 19, 0.3)';
      });
      btn.addEventListener('mouseleave', () => {
        btn.style.transform = 'translateY(0)';
        btn.style.boxShadow = 'none';
      });
      
      msgArea.appendChild(btn);
      
      setTimeout(()=> {
        const el = document.getElementById('downloadTicketBtn');
        if(el) el.remove();
      }, 45000);
    }

    // Generar comprobante (función mantenida del original pero mejorada visualmente)
    async function generateTicketImage(turno, cliente){
      const W = 1200; const H = 800;
      const c = document.createElement('canvas'); 
      c.width = W; c.height = H;
      const ctx = c.getContext('2d');

      // Fondo base
      ctx.fillStyle = '#ffffff'; 
      ctx.fillRect(0,0,W,H);

      // Header con gradiente
      const gradient = ctx.createLinearGradient(0, 0, W, 120);
      gradient.addColorStop(0, '#440D13');
      gradient.addColorStop(1, '#5a1119');
      ctx.fillStyle = gradient; 
      ctx.fillRect(0,0,W,120);

      // Título
      ctx.fillStyle = '#fff'; 
      ctx.font = '700 32px "Space Grotesk", sans-serif'; 
      ctx.textAlign = 'center';
      ctx.fillText('Comprobante de Reserva', W/2, 74);

      // Área del comprobante
      const margin = 60; 
      const cardTop = 150; 
      const cardH = H - cardTop - 80;
      
      ctx.fillStyle = '#fafbfc'; 
      ctx.fillRect(margin, cardTop, W - margin*2, cardH);
      ctx.strokeStyle = '#e5e7eb'; 
      ctx.lineWidth = 2;
      ctx.strokeRect(margin, cardTop, W - margin*2, cardH);

      // Contenido en dos columnas
      const leftX = margin + 40; 
      const midX = W/2 + 20; 
      let y = cardTop + 50; 
      const lh = 38;
      
      ctx.textAlign = 'left';

      // Columna izquierda - Cliente
      ctx.fillStyle = '#111827'; 
      ctx.font = '700 24px "Space Grotesk", sans-serif'; 
      ctx.fillText('Datos del Cliente', leftX, y); y += lh + 10;
      
      ctx.font = '600 18px "Manrope", sans-serif'; 
      ctx.fillText('Nombre: ' + (cliente.nombre || '-'), leftX, y); y += lh;
      ctx.fillText('WhatsApp: ' + (cliente.whatsapp || '-'), leftX, y); y += lh;
      ctx.fillText('Email: ' + (cliente.email || '-'), leftX, y); y += lh + 20;

      // Columna derecha - Turno
      let ry = cardTop + 50;
      ctx.font = '700 24px "Space Grotesk", sans-serif'; 
      ctx.fillText('Detalles del Turno', midX, ry); ry += lh + 10;
      
      ctx.font = '600 18px "Manrope", sans-serif'; 
      ctx.fillText('Fecha: ' + (turno.fecha || '-'), midX, ry); ry += lh;
      ctx.fillText('Hora: ' + (turno.hora || '-'), midX, ry); ry += lh;
      ctx.fillText('Precio: $' + (Number(turno.precio||0).toLocaleString('es-AR')), midX, ry); ry += lh;
      ctx.fillText('Ubicación: ' + (turno.ubicacion || '-'), midX, ry); ry += lh + 20;

      // Descripción
      let descY = Math.max(y, ry);
      ctx.font = '700 20px "Space Grotesk", sans-serif'; 
      ctx.fillText('Descripción:', leftX, descY); descY += 30;
      ctx.font = '400 16px "Manrope", sans-serif'; 
      wrapText(ctx, String(turno.descripcion || 'Sin descripción'), leftX, descY, W - margin*2 - 80, 24);

      // Footer
      ctx.fillStyle = '#6b7280'; 
      ctx.font = '14px "Manrope", sans-serif'; 
      ctx.textAlign = 'center';
      ctx.fillText('Presentá este comprobante en el establecimiento • Reserva confirmada via web', W/2, H - 40);

      return c.toDataURL('image/png');
    }

    // Función auxiliar para texto multilínea
    function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
      const words = text.split(' ');
      let line = '';
      
      for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        const testWidth = metrics.width;
        
        if (testWidth > maxWidth && n > 0) {
          ctx.fillText(line, x, y);
          line = words[n] + ' ';
          y += lineHeight;
        } else {
          line = testLine;
        }
      }
      ctx.fillText(line, x, y);
    }

    // Función para filtrar y renderizar turnos
    function aplicarFiltrosYRender(){
      grid.innerHTML = '';
      
      const query = (searchInput.value || '').trim().toLowerCase();
      const stateFilter = (filterState.value || 'all');
      const tokens = query.split(/\s+/).filter(Boolean);

      const keys = Object.keys(allTurnos || {}).sort((a,b) => {
        const A = ((allTurnos[a].fecha || '') + ' ' + (allTurnos[a].hora || ''));
        const B = ((allTurnos[b].fecha || '') + ' ' + (allTurnos[b].hora || ''));
        return A.localeCompare(B);
      });

      let count = 0;
      
      keys.forEach((id, index) => {
        const turno = allTurnos[id];
        if (!turno) return;
        
        const estado = turno.estado || 'disponible';
        
        // Filtro por estado
        if (stateFilter !== 'all' && estado !== stateFilter) return;
        
        // Filtro de búsqueda
        if (tokens.length > 0) {
          const searchableFields = [
            turno.fecha || '',
            turno.hora || '',
            turno.descripcion || '',
            turno.ubicacion || '',
          ].map(s => String(s).toLowerCase());
          
          const matchesQuery = tokens.every(token =>
            searchableFields.some(field => field.includes(token))
          );
          
          if (!matchesQuery) return;
        }
        
        const cardElement = crearCard(id, turno);
        cardElement.style.animationDelay = `${index * 0.1}s`;
        grid.appendChild(cardElement);
        count++;
      });

      countEl.textContent = count;
      
      // Mostrar mensaje si no hay resultados
      if (count === 0) {
        const noResults = document.createElement('div');
        noResults.style.cssText = `
          grid-column: 1 / -1;
          text-align: center;
          padding: 60px 20px;
          color: var(--text-secondary);
          font-family: 'Manrope', sans-serif;
          font-size: 1.1rem;
        `;
        noResults.innerHTML = `
          <div style="font-size: 4rem; margin-bottom: 20px; opacity: 0.3;">🔍</div>
          <div>No se encontraron turnos</div>
          <div style="font-size: 0.9rem; margin-top: 8px;">Probá con otros términos de búsqueda</div>
        `;
        grid.appendChild(noResults);
      }
    }

    // Event listeners para filtros
    searchInput.addEventListener('input', aplicarFiltrosYRender);
    filterState.addEventListener('change', aplicarFiltrosYRender);

    // Tabs (mantenido para compatibilidad)
    document.querySelectorAll('.tab').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        aplicarFiltrosYRender();
      });
    });

    // Escuchar cambios en Firebase
    onValue(siteRef, (snap) => {
      const s = snap.val() || {};
      
      // Logo
      if(s.logoUrl){
        siteLogoImg.src = s.logoUrl;
        siteLogoImg.style.display = 'block';
      } else {
        siteLogoImg.style.display = 'none';
      }

      // Promoción
      const promo = s.promocion || null;
      if(promo && promo.imageUrl){
        const closedKey = sessionStorage.getItem('promoClosedAt');
        if(closedKey && String(closedKey) === String(promo.createdAt)){
          // Usuario ya cerró esta promoción
        } else {
          // Mostrar promoción
          promoImg.src = promo.imageUrl;
          promoBackdrop.classList.add('show');
          promoBackdrop.setAttribute('aria-hidden', 'false');
        }
      } else {
        promoBackdrop.classList.remove('show');
        promoBackdrop.setAttribute('aria-hidden', 'true');
      }
    });

    // Event listeners para cerrar promoción
    promoTop.addEventListener('click', closePromo);
    promoX.addEventListener('click', closePromo);
    
    async function closePromo() {
      const snap = await get(siteRef);
      const s = snap.val() || {};
      const promo = s.promocion || {};
      
      promoBackdrop.classList.remove('show');
      promoBackdrop.setAttribute('aria-hidden', 'true');
      
      if(promo.createdAt) {
        sessionStorage.setItem('promoClosedAt', String(promo.createdAt));
      }
    }

    // Escuchar turnos
    onValue(turnosRef, (snapshot) => {
      allTurnos = snapshot.val() || {};
      aplicarFiltrosYRender();
    }, (err)=> {
      console.error(err);
      showMessage('Error de conexión. Intenta recargar la página.', 'error');
    });

    // FAB (WhatsApp)
    const fab = document.getElementById('fab');
    if(fab){
      fab.addEventListener('click', (e) => {
        const href = fab.getAttribute('data-href');
        if(href){ 
          window.open(href, '_blank', 'noopener');
        }
      });
    }

    // Cerrar modales con Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (resBackdrop.classList.contains('show')) {
          closeReservationModal();
        }
        if (promoBackdrop.classList.contains('show')) {
          closePromo();
        }
      }
    });

    // Cerrar modales haciendo clic fuera
    resBackdrop.addEventListener('click', (e) => {
      if (e.target === resBackdrop) {
        closeReservationModal();
      }
    });

    promoBackdrop.addEventListener('click', (e) => {
      if (e.target === promoBackdrop) {
        closePromo();
      }
    });

  </script>
</body>
</html>