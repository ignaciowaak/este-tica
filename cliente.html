<!doctype html>
<html lang="es">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Turnos ‚Äî Cliente</title>
  <style>
    /* Franja superior animada */
    .promo-bar {
      width: 100vw;
      min-width: 100%;
      background: #440D13;
      border-bottom: 1.5px solid #111;
      border-top: 1.5px solid #111;
      padding: 0;
      overflow: hidden;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 200;
      height: 38px;
      display: flex;
      align-items: center;
      box-sizing: border-box;
    }
    .promo-bar-text {
      color: #ffffff;
      font-family: 'Inter', 'Lato', Arial, sans-serif;
      font-size: 1.15rem;
      font-weight: 600;
      white-space: nowrap;
      display: inline-block;
      animation: promoScroll 12s linear infinite;
      letter-spacing: 1px;
      padding-left: 0;
    }
    @keyframes promoScroll {
      0% { transform: translateX(100vw); }
      100% { transform: translateX(-100vw); }
    }
  body { padding-top: 0; }
    :root{
      --bg: #E8E6DA;
      --card: #E8E6DA;
      --muted: #666;
      --accent: #440D13;
      --accent-strong: #ffffff;
      --promo-height: 60px;
      --text-main: #111;
      --text-secondary: #555;
      --border: #eee;
      --shadow: 0 2px 16px 0 rgba(0,0,0,0.06);
      --radius: 16px;
      --header-height: 72px;
      font-family: 'Inter', 'Lato', 'Helvetica Neue', Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: var(--bg);
      min-height:100vh;
      color:var(--text-main);
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:0;
      font-family: var(--font-body);
      transition: background 0.6s;
    }
    .wrap{
      width:100%;
      max-width:1100px;
      margin:0 auto;
      /* Deja espacio extra para la barra y el header */
      padding-top: calc(var(--promo-height) + var(--header-height) + 24px);
      padding-bottom: 0;
    }
    header{
      width:100%;
      min-height:var(--header-height);
      background:var(--bg);
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
      padding:32px 32px 0 32px;
      box-sizing:border-box;
      margin-bottom:32px;
      position:relative;
      z-index:250;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
  .brand img{height:72px;width:auto;border-radius:0px;display:block;box-shadow:none;transition:box-shadow 0.3s;}
  h1{margin:0;font-size:2.6rem;letter-spacing:1px;color:var(--text-main);font-family:'Playfair Display',serif;font-weight:700;line-height:1.1;}
  p.lead{margin:0;color:var(--text-secondary);font-size:1.15rem;font-family:var(--font-body);}
    .controls{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:24px;
      flex-wrap:wrap;
      background:var(--bg);
      border-radius:var(--radius);
      box-shadow:none;
      padding:0;
    }
    input[type="search"], select{
      padding:10px 16px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--bg);
      color:var(--text-main);
      font-size:1rem;
      box-shadow:none;
      transition:border-color 0.3s, color 0.3s;
      outline:none;
    }
    input[type="search"]:focus, select:focus{
      border-color:var(--accent);
      color:var(--accent-strong);
    }
  .tabs{display:flex;gap:10px}
  .tab{padding:10px 18px;border-radius:12px;background:var(--bg);border:1px solid var(--border);cursor:pointer;color:var(--text-main);font-weight:600;transition:border-color 0.3s, color 0.3s;}
  .tab.active, .tab:hover{border-color:var(--accent);color:var(--accent-strong);background:var(--accent);}
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap:28px;
      justify-items:center;
      padding:0 8px;
    }
    @media (max-width:700px){
      .grid{
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap:12px;
        padding:0 6px;
      }
      .card{
        min-width:0;
        max-width:100%;
        padding:12px 8px;
        border-radius:10px;
      }
      .images img{
        width:100%;
        min-width:0;
        max-width:100vw;
        height:auto;
        aspect-ratio:1/1;
        border-radius:10px;
      }
      .meta{
        flex-direction:column;
        align-items:flex-start;
        gap:6px;
      }
    }
    .card{
      background:var(--card);
      border-radius:0px;
       border:1px solid #111;
      padding:18px 12px 14px 12px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:14px;
      align-items:center;
      min-width:180px;
      max-width:260px;
      transition:box-shadow 0.3s, border-color 0.3s;
      animation:fadeInCard 0.7s;
    }
    @keyframes fadeInCard {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: none; }
    }
  .images{display:flex;gap:8px;overflow:auto;padding-bottom:6px;justify-content:center;}
    .images img{
      width:100%;
      max-width:180px;
      min-width:120px;
      aspect-ratio:1/1;
      object-fit:cover;
      border-radius:0px;
      border:0px solid #111;
      box-shadow:none;
      cursor:pointer;
      background:#fff;
      display:block;
      margin:0 auto;
      transition:transform 0.3s;
    }
  .images img:hover{transform:scale(1.04);box-shadow:0 6px 24px rgba(68,13,19,0.53);}
  .meta{display:flex;flex-direction:column;align-items:center;width:100%;margin-top:8px;gap:6px;}
  .muted{color:var(--muted);font-size:1rem;text-align:center;}
  .price{font-weight:800;color:#440D13;font-size:1.08rem;text-align:center;}
  button{border:0;padding:12px 24px;border-radius:12px;cursor:pointer;font-weight:600;font-size:1rem;background:var(--bg);color:var(--text-main);border:1px solid var(--border);transition:border-color 0.3s, color 0.3s;box-shadow:none;}
  button:hover:not(:disabled){border-color:var(--accent-strong);color:var(--accent-strong);background:var(--accent);}
  .btn-reservar{background:var(--accent);color:#FAF3E0;border:1px solid var(--accent-strong);}
  .btn-reservar:hover{background:var(--accent-strong);color:#FAF3E0;}
  .btn-disabled{background:#f7f7f7;color:#bbb;cursor:not-allowed;border:1px solid #eee;}
  .status-available{color:var(--accent-strong);font-weight:700;}
  .status-reserved{color:var(--muted);font-weight:700;}
  .footer{display:flex;justify-content:space-between;align-items:center;margin-top:32px;flex-wrap:wrap;gap:8px;background:var(--bg);border-radius:var(--radius);padding:8px 14px;box-shadow:none;border-top:1px solid var(--border);}
  .msg{padding:10px 18px;border-radius:12px;background:var(--accent);color:var(--text-main);box-shadow:var(--shadow);font-size:1rem;}
  .msg.success{background:var(--accent);color:var(--text-main);border:1px solid var(--accent-strong);}
  .msg.error{background:rgba(68,13,19,0.06);color:var(--accent-strong);border:1px solid var(--accent-strong);} 
    @media (max-width:700px){
      header{flex-direction:column;align-items:flex-start;padding:0 8px;}
      /* keep space for promo bar + header on small screens to avoid overlap */
      .wrap{padding-top: calc(var(--promo-height) + var(--header-height) + 12px); padding-left:8px; padding-right:8px;}
      .card{padding:10px;}
  .brand img{height:66px;}
      h1{font-size:1.6rem;}
    }

  /* Reservation modal (styled to match site) */
  .resBackdrop{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(3,6,8,0.45);z-index:220;visibility:hidden;opacity:0;transition:opacity 180ms ease, visibility 180ms}
  .resBackdrop.show{visibility:visible;opacity:1}
  .resModal{background:var(--card);border-radius:14px;padding:18px;width:100%;max-width:520px;box-shadow:0 24px 60px rgba(2,8,23,0.45);color:var(--text-main)}
  .resModal h3{margin:0 0 8px 0;font-family:'Playfair Display', serif}
  .resForm{display:flex;flex-direction:column;gap:10px;margin-top:8px;}
  .resForm input{padding:12px;border-radius:10px;border:1px solid var(--border);font-size:1rem}
  .resForm .row{display:flex;gap:10px}
  .resForm .row .flex{flex:1}
  .resActions{display:flex;justify-content:flex-end;gap:8px;margin-top:6px}
  .resPrimary{background:var(--accent);color:var(--accent-strong);padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
  .resCancel{background:transparent;border:1px solid var(--border);padding:10px 14px;border-radius:10px;cursor:pointer}
  /* Promo modal (centered image, not full-bleed) */
  .promoBackdrop{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(68,13,19,0.12);z-index:120;visibility:hidden;opacity:0;transition:opacity 180ms ease, visibility 180ms}
  .promoBackdrop.show{visibility:visible;opacity:1}
  .promoCard{background:var(--card);border-radius:var(--radius);padding:18px;max-width:90%;max-height:85vh;display:flex;align-items:center;justify-content:center;position:relative;box-shadow:var(--shadow);}
  .promoCard img{max-width:86vw;max-height:78vh;border-radius:14px;box-shadow:0 30px 60px rgba(68,13,19,0.53);display:block;transition:box-shadow 0.3s;}
    /* flechita arriba (cierra) */
    .promoCloseTop{
      position:absolute;left:50%;transform:translateX(-50%);top:-28px;background:transparent;border:0;color:var(--accent);font-size:34px;cursor:pointer;
      text-shadow:0 4px 20px rgba(0,0,0,0.12);
    }
    .promoCloseSmall{
      position:absolute;right:-50px;top:-5px;background:var(--accent);border-radius:50%;width:36px;height:36px;border:0;color:#fff;font-size:18px;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      transition:background 0.9s;
    }

    /* Ticket download helper */
    .ticketDownload{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--card);
      cursor:pointer;
    }

    /* Floating action button (small, round, mobile-friendly) */
    .fab{
      position:fixed;
      right:14px;
      bottom:18px;
      width:56px;
      height:56px;
      border-radius:50%;
      border:0;
      background:var(--accent);
      box-shadow:0 8px 24px rgba(68,13,19,0.28);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:400;
      padding:6px;
      cursor:pointer;
    }
    .fab img{width:100%;height:100%;object-fit:contain;border-radius:50%}
    @media(min-width:700px){
      .fab{width:64px;height:64px;right:22px;bottom:22px}
    }

  </style>
</head>
<body>
  <div class="promo-bar">
    <div class="promo-bar-text">
      50% off los jueves &nbsp; 50% off los jueves &nbsp; 50% off los jueves &nbsp; 50% off los jueves &nbsp; 50% off los jueves  50% off los jueves &nbsp; 50% off los jueves &nbsp; 50% off los jueves &nbsp; 50% off los jueves &nbsp; 50% off los jueves
    </div>
  </div>
  <div class="wrap">
    
    <header>
      <div class="brand">
        <img id="siteLogo" src="" alt="Logo" onerror="this.style.display='none'">
        <!-- Coloca aqu√≠ tu logo local para que aparezca en el comprobante: -->
        <img id="receiptLogo" src="logo.png" alt="Logo comprobante" style="display:none;" onerror="this.style.display='none'">
        <div>
          <h1>Reserv√° tu turno</h1>
          <p class="lead">Elegi tu turno en la mejor est√©tica.</p>
        </div>
      </div>
      <div class="muted">Servidor de turnos</div>
    </header>

    <div class="controls">
      <div style="display:flex;gap:8px;align-items:center">
  <input id="search" type="search" placeholder="Buscar">
        <select id="filterState">
          <option value="all">Todos</option>
          <option value="disponible">Disponibles</option>
          <option value="reservado">Reservados</option>
        </select>
      </div>
      <div class="tabs" role="tablist" aria-label="Ver">
        <button class="tab active" data-tab="all">Todos</button>
      </div>
    </div>

    <section id="turnosSection">
      <div id="turnosGrid" class="grid" aria-live="polite"></div>

      <div class="footer">
        <div id="messageArea"></div>
        <div class="muted">Turnos: <span id="count">0</span></div>
      </div>
    </section>
  </div>

  <!-- Reservation modal -->
  <div id="resBackdrop" class="resBackdrop" aria-hidden="true">
    <div class="resModal" role="dialog" aria-modal="true" aria-labelledby="resTitle">
      <h3 id="resTitle">Reservar turno</h3>
      <form id="resForm" class="resForm">
        <input id="resName" type="text" placeholder="Nombre completo" required>
        <div class="row">
          <input id="resWhatsapp" class="flex" type="text" placeholder="WhatsApp (ej: 341xxxxxxx)" required>
            <input id="resEmail" class="flex" type="email" placeholder="Gmail (ej: ejemplo@gmail.com)">
        </div>
        <div class="resActions">
          <button type="button" id="resCancel" class="resCancel">Cancelar</button>
          <button type="submit" id="resSubmit" class="resPrimary">Confirmar y descargar comprobante</button>
        </div>
      </form>
    </div>
  </div>

  <!-- PROMO modal (image centered, flechita arriba) -->
  <div id="promoBackdrop" class="promoBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="promoCard">
      <button id="promoTop" class="promoCloseTop" title="Cerrar">ÀÑ</button>
      <button id="promoX" class="promoCloseSmall" title="Cerrar">‚úï</button>
      <img id="promoImg" src="" alt="Promoci√≥n">
    </div>
  </div>

  <!-- Floating action button (edit src and data-href manually) -->
  <button id="fab" class="fab" data-href="http://wa.me/2235703012" aria-label="Acci√≥n r√°pida">
    <img id="fabImg" src="w.jpg" alt="Acci√≥n" onerror="this.style.display='none'" />
  </button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getDatabase, ref as dbRef, onValue, get, update } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhz1XHoprhhrHyYfuAdIYGMJxm5UsDO-4",
      authDomain: "the-pic-c437e.firebaseapp.com",
      databaseURL: "https://the-pic-c437e-default-rtdb.firebaseio.com",
      projectId: "the-pic-c437e",
      storageBucket: "the-pic-c437e.appspot.com",
      messagingSenderId: "750954597180",
      appId: "1:750954597180:web:fc586d73d852ed5e17ec39"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const turnosRef = dbRef(db, 'turnos');
    const siteRef = dbRef(db, 'site');

    const grid = document.getElementById('turnosGrid');
    const countEl = document.getElementById('count');
    const msgArea = document.getElementById('messageArea');
    const searchInput = document.getElementById('search');
    const filterState = document.getElementById('filterState');
    const tabs = document.querySelectorAll('.tab');
    const siteLogoImg = document.getElementById('siteLogo');

    // promo elements
    const promoBackdrop = document.getElementById('promoBackdrop');
    const promoImg = document.getElementById('promoImg');
    const promoTop = document.getElementById('promoTop');
    const promoX = document.getElementById('promoX');

    // reservation modal elements
    const resBackdrop = document.getElementById('resBackdrop');
    const resForm = document.getElementById('resForm');
    const resName = document.getElementById('resName');
    const resWhatsapp = document.getElementById('resWhatsapp');
    const resEmail = document.getElementById('resEmail');
    const resCancel = document.getElementById('resCancel');
    const resSubmit = document.getElementById('resSubmit');

    // ticket download helper (if user wants to re-download)
    let lastTicketDataUrl = null;

    let allTurnos = {};
    let currentTab = 'all';
    let turnoToReserve = null;

    function showMessage(text, type='success', timeout=3500){
      msgArea.innerHTML = '';
      const d = document.createElement('div');
      d.className = 'msg ' + (type === 'success' ? 'success' : 'error');
      d.textContent = text;
      msgArea.appendChild(d);
      setTimeout(()=> { if(msgArea.contains(d)) msgArea.removeChild(d); }, timeout);
    }

    function crearCard(id, data){
      const card = document.createElement('article');
      card.className = 'card';

      const imgWrap = document.createElement('div');
      imgWrap.className = 'images';
      if(Array.isArray(data.imagenes) && data.imagenes.length){
        data.imagenes.forEach(url => {
          const img = document.createElement('img');
          img.src = url;
          img.alt = 'Imagen turno';
          // Evento para pantalla completa
          img.style.cursor = 'pointer';
          img.addEventListener('click', () => {
            promoImg.src = url;
            promoBackdrop.classList.add('show');
            promoBackdrop.setAttribute('aria-hidden', 'false');
          });
          imgWrap.appendChild(img);
        });
      } else {
        const img = document.createElement('img');
        img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="240"><rect width="100%" height="100%" fill="%23eef6ff"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%238aa9d8" font-family="Arial" font-size="18">Sin im√°genes</text></svg>';
        img.style.height='120px';
        imgWrap.appendChild(img);
      }

      const title = document.createElement('div');
      title.innerHTML = `<div style="font-weight:800">${data.fecha} ‚Ä¢ ${data.hora}</div><div class="muted">${data.ubicacion || ''}</div>`;

      const price = document.createElement('div');
      price.innerHTML = `<div class="price">$ ${Number(data.precio || 0).toLocaleString('es-AR')}</div><div class="muted">precio</div>`;

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.appendChild(title);
      meta.appendChild(price);

      const desc = document.createElement('div');
      desc.className = 'muted';
      desc.textContent = data.descripcion || '';

      const statusLine = document.createElement('div');
      statusLine.style.display = 'flex';
      statusLine.style.justifyContent = 'space-between';
      statusLine.style.alignItems = 'center';
      statusLine.style.gap = '8px';

      const status = document.createElement('div');
      const estado = data.estado || 'disponible';
      if(estado === 'disponible'){
        status.innerHTML = `<span class="status-available">Disponible</span>`;
      } else {
        status.innerHTML = `<span class="status-reserved">Turno reservado</span>`;
      }

      const btn = document.createElement('button');
      btn.style.marginLeft = '8px';
      if(estado === 'disponible'){
        btn.className = 'btn-reservar';
        btn.textContent = 'Reservar';
        btn.onclick = () => openReservationModal(id, data);
      } else {
        btn.className = 'btn-disabled';
        btn.textContent = 'No disponible';
        btn.disabled = true;
      }

      statusLine.appendChild(status);
      statusLine.appendChild(btn);

      card.appendChild(imgWrap);
      card.appendChild(meta);
      card.appendChild(desc);
      card.appendChild(statusLine);

      return card;
    }

    function openReservationModal(id, data){
      turnoToReserve = { id, data };
      // reset form
      resForm.reset();
      resBackdrop.classList.add('show');
      resBackdrop.setAttribute('aria-hidden', 'false');
      resName.focus();
    }

    function closeReservationModal(){
      resBackdrop.classList.remove('show');
      resBackdrop.setAttribute('aria-hidden', 'true');
      turnoToReserve = null;
    }

    // Reservation form handlers
    resCancel.addEventListener('click', () => {
      closeReservationModal();
      showMessage('Reserva cancelada', 'error');
    });

    resForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if(!turnoToReserve) { showMessage('No se detect√≥ el turno a reservar', 'error'); closeReservationModal(); return; }
      const nombre = resName.value.trim();
      const whatsapp = resWhatsapp.value.trim().replace(/\D/g,'');
      const email = resEmail.value.trim();

      if(nombre.length < 3){ showMessage('Ingres√° tu nombre completo.', 'error'); return; }
      if(!/^\d{6,15}$/.test(whatsapp)){ showMessage('Ingres√° un n√∫mero de WhatsApp v√°lido (s√≥lo d√≠gitos).', 'error'); return; }
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ showMessage('Ingres√° un correo v√°lido.', 'error'); return; }

      // disable submit to prevent double clicks
      resSubmit.disabled = true;

      try {
        const id = turnoToReserve.id;
        // check current state
        const snap = await get(dbRef(db, 'turnos/' + id));
        if(!snap.exists()){
          showMessage('El turno ya no existe.', 'error');
          closeReservationModal();
          return;
        }
        const current = snap.val();
        if(current.estado === 'reservado'){
          showMessage('Ese turno ya fue reservado por otro usuario.', 'error');
          closeReservationModal();
          return;
        }

        // update DB (same fields as before)
        await update(dbRef(db, 'turnos/' + id), {
          reservadoPor: nombre,
          telefonoWhatsapp: whatsapp,
          telefono: whatsapp,
          emailCliente: email,
          estado: 'reservado'
        });

        showMessage('Reserva registrada. Generando comprobante...', 'success');

        // Prepare ticket data: prefer latest data from DB (current may be stale), get again
        const finalSnap = await get(dbRef(db, 'turnos/' + id));
        const finalData = finalSnap.val() || turnoToReserve.data;

        // Create ticket image and trigger download
        try {
          const ticketDataUrl = await generateTicketImage(finalData, { nombre, whatsapp, email });
          lastTicketDataUrl = ticketDataUrl;
          // auto-download
          triggerDownload(ticketDataUrl, buildFileName(finalData));
          // Show short success and provide download helper
          showDownloadHelper(ticketDataUrl);
        } catch(imgErr){
          console.error('Error generando comprobante:', imgErr);
          showMessage('Reserva OK ‚Äî pero fall√≥ la generaci√≥n del comprobante (ver consola).', 'error');
        }

        closeReservationModal();
      } catch(err){
        console.error(err);
        showMessage('Error al reservar (ver consola)', 'error');
      } finally {
        resSubmit.disabled = false;
      }
    });

    // helper to trigger download
    function triggerDownload(dataUrl, filename){
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function buildFileName(turno){
      const safeDate = (turno.fecha || '').replace(/-/g,'');
      const safeTime = (turno.hora || '').replace(/:/g,'');
      return `comprobante_turno_${safeDate}_${safeTime}.png`;
    }

    function showDownloadHelper(dataUrl){
      // append small button near messageArea so user can download again
      const existing = document.getElementById('downloadTicketBtn');
      if(existing) existing.remove();
      const btn = document.createElement('button');
      btn.id = 'downloadTicketBtn';
      btn.className = 'ticketDownload';
      btn.innerHTML = 'üì• Descargar comprobante';
      btn.onclick = () => triggerDownload(dataUrl, 'comprobante.png');
      msgArea.appendChild(btn);
      // auto-remove after 45s
      setTimeout(()=> {
        const el = document.getElementById('downloadTicketBtn');
        if(el) el.remove();
      }, 45000);
    }

    // generate ticket image using canvas
    async function generateTicketImage(turno, cliente){
      const W = 1200; const H = 780;
      const c = document.createElement('canvas'); c.width = W; c.height = H;
      const ctx = c.getContext('2d');

      // base
      ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,W,H);

      // top band
      const accent = (getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#440D13').trim();
      ctx.fillStyle = accent; ctx.fillRect(0,0,W,120);

      // title
      ctx.fillStyle = '#fff'; ctx.font = '700 28px "Playfair Display", serif'; ctx.textAlign = 'center';
      ctx.fillText('Comprobante de Reserva', W/2, 74);

      // white card area
      const margin = 56; const cardTop = 140; const cardH = H - cardTop - 60;
      ctx.fillStyle = '#fafafa'; ctx.fillRect(margin, cardTop, W - margin*2, cardH);
      ctx.strokeStyle = '#eee'; ctx.strokeRect(margin, cardTop, W - margin*2, cardH);

      // left column (cliente) and right column (turno)
      const leftX = margin + 28; const midX = W/2 + 10; let y = cardTop + 34; const lh = 34;
      ctx.textAlign = 'left';

      ctx.fillStyle = '#222'; ctx.font = '700 20px "Inter", sans-serif'; ctx.fillText('Cliente', leftX, y); y += lh;
      ctx.font = '600 18px sans-serif'; ctx.fillText('Nombre: ' + (cliente.nombre || '-'), leftX, y); y += lh;
      ctx.fillText('WhatsApp: ' + (cliente.whatsapp || '-'), leftX, y); y += lh;
      ctx.fillText('Email: ' + (cliente.email || '-'), leftX, y); y += lh + 8;

      // right column
      let ry = cardTop + 34;
      ctx.font = '700 20px "Inter", sans-serif'; ctx.fillText('Detalle del turno', midX, ry); ry += lh;
      ctx.font = '600 18px sans-serif'; ctx.fillText('Fecha: ' + (turno.fecha || '-'), midX, ry); ry += lh;
      ctx.fillText('Hora: ' + (turno.hora || '-'), midX, ry); ry += lh;
      ctx.fillText('Precio: $ ' + (Number(turno.precio||0).toLocaleString('es-AR')), midX, ry); ry += lh;
      ctx.fillText('Ubicaci√≥n: ' + (turno.ubicacion || '-'), midX, ry); ry += lh;

      // description full width
      let descY = Math.max(y, ry) + 12;
      ctx.font = '700 18px "Inter", sans-serif'; ctx.fillText('Descripci√≥n:', leftX, descY); descY += 24;
      ctx.font = '600 16px sans-serif'; wrapText(ctx, String(turno.descripcion || '-'), leftX, descY, W - margin*2 - 40, 22);

      // footer
      ctx.fillStyle = '#666'; ctx.font = '14px sans-serif'; ctx.textAlign = 'center';
      ctx.fillText('Present√° este comprobante en el local. Reservado mediante sistema web.', W/2, H - 30);

      // draw a subtle large logo watermark bottom-right (doesn't block text)
      try {
        await drawLogoWatermark(ctx, W, H, { margin: margin, cardTop: cardTop, cardH: cardH });
      } catch(e){ /* ignore watermark errors */ }

      return c.toDataURL('image/png');
    }

    // draw a watermark logo in bottom-right with low opacity
    async function drawLogoWatermark(ctx, canvasW, canvasH, opts){
      const local = document.getElementById('receiptLogo');
      const src = (local && local.src) ? local.src : (siteLogoImg && siteLogoImg.src ? siteLogoImg.src : '');
      if(!src) return;
      const img = new Image(); img.crossOrigin = 'anonymous';
      return new Promise((resolve) => {
        img.onload = () => {
          try {
            const margin = (opts && opts.margin) ? opts.margin : 56;
            const cardTop = (opts && opts.cardTop) ? opts.cardTop : 140;
            const cardH = (opts && opts.cardH) ? opts.cardH : (canvasH - cardTop - 60);
            // place watermark within the card area bottom-right but with low alpha
            const maxW = Math.min((canvasW - margin*2) * 0.45, 420);
            const maxH = Math.min(cardH * 0.6, 420);
            let w = img.width; let h = img.height;
            const ratio = Math.min(maxW / w, maxH / h, 1);
            w = Math.round(w * ratio); h = Math.round(h * ratio);
            const x = canvasW - margin - w - 20;
            const y = cardTop + cardH - h - 20;
            ctx.save();
            ctx.globalAlpha = 0.12;
            try { ctx.drawImage(img, x, y, w, h); } catch(e) { /* ignore draw errors (CORS) */ }
            ctx.restore();
          } catch(e){ /* ignore */ }
          resolve();
        };
        img.onerror = () => { resolve(); };
        try { img.src = src; } catch(e){ resolve(); }
      });
    }

    // helper to wrap text on canvas
    function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
      const words = text.split(' ');
      let line = '';
      for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        const testWidth = metrics.width;
        if (testWidth > maxWidth && n > 0) {
          ctx.fillText(line, x, y);
          line = words[n] + ' ';
          y += lineHeight;
        } else {
          line = testLine;
        }
      }
      ctx.fillText(line, x, y);
    }

    // Render turnos applying search and state filters
    function aplicarFiltrosYRender(){
      grid.innerHTML = '';
      const raw = (searchInput.value || '').trim().toLowerCase();
      const stateFilter = (filterState.value || 'all');

      // tokenize query by spaces; ignore empty tokens
      const tokens = raw.split(/\s+/).filter(Boolean);

      const keys = Object.keys(allTurnos || {}).sort((a,b) => {
        const A = ((allTurnos[a].fecha || '') + ' ' + (allTurnos[a].hora || ''));
        const B = ((allTurnos[b].fecha || '') + ' ' + (allTurnos[b].hora || ''));
        return A.localeCompare(B);
      });
      let cnt = 0;
      keys.forEach(id => {
        const t = allTurnos[id];
        if(!t) return;
        const estado = t.estado || 'disponible';
        if(stateFilter !== 'all' && estado !== stateFilter) return;

        // build searchable text fields
        const fields = [
          t.fecha || '',
          t.hora || '',
          (t.descripcion || ''),
          (t.ubicacion || ''),
          (t.titulo || '')
        ].map(s => String(s).toLowerCase());

        // if no tokens, match everything
        let ok = true;
        for(const token of tokens){
          // token must match at least one field either as full word or as prefix (first 2-4 letters)
          const minPrefix = Math.min(4, Math.max(2, token.length));
          const prefix = token.slice(0, minPrefix);
          const tokenOk = fields.some(f => {
            // full word match (word boundary)
            if(new RegExp('\\b' + escapeRegex(token) + '\\b').test(f)) return true;
            // prefix match (start of any word)
            if(new RegExp('\\b' + escapeRegex(prefix)).test(f)) return true;
            // substring fallback
            if(f.includes(token)) return true;
            return false;
          });
          if(!tokenOk){ ok = false; break; }
        }

        if(!ok) return;

        grid.appendChild(crearCard(id, t));
        cnt++;
      });
      countEl.textContent = cnt;
    }

    // small helper to escape regex metachars
    function escapeRegex(s){
      return String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // Tabs
    document.querySelectorAll('.tab').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        if(tab === 'all') currentTab = 'all';
        else if(tab === 'disponibles') currentTab = 'disponibles';
        else if(tab === 'reservados') currentTab = 'reservados';
        aplicarFiltrosYRender();
      });
    });

    searchInput.addEventListener('input', aplicarFiltrosYRender);
    filterState.addEventListener('change', aplicarFiltrosYRender);

    // Listen for logo and promo in siteRef
    onValue(siteRef, (snap) => {
      const s = snap.val() || {};
      if(s.logoUrl){
        siteLogoImg.src = s.logoUrl;
        siteLogoImg.style.display = 'block';
      } else {
        siteLogoImg.style.display = 'none';
      }

      // Promotion handling
      const promo = s.promocion || null;
      if(promo && promo.imageUrl){
        // show promo only if not closed this session or if new createdAt differs
        const closedKey = sessionStorage.getItem('promoClosedAt');
        if(closedKey && String(closedKey) === String(promo.createdAt)){
          // user closed this exact promo in this session, do nothing
        } else {
          // show promo
          promoImg.src = promo.imageUrl;
          promoBackdrop.classList.add('show');
          promoBackdrop.setAttribute('aria-hidden', 'false');
        }
      } else {
        promoBackdrop.classList.remove('show');
        promoBackdrop.setAttribute('aria-hidden', 'true');
      }
    });

    // Promo close handlers (top arrow and X)
    promoTop.addEventListener('click', async () => {
      const snap = await get(siteRef);
      const s = snap.val() || {};
      const promo = s.promocion || {};
      closePromo(promo.createdAt || null);
    });
    promoX.addEventListener('click', async () => {
      const snap = await get(siteRef);
      const s = snap.val() || {};
      const promo = s.promocion || {};
      closePromo(promo.createdAt || null);
    });

    function closePromo(promoCreatedAt = null){
      promoBackdrop.classList.remove('show');
      promoBackdrop.setAttribute('aria-hidden', 'true');
      if(promoCreatedAt) sessionStorage.setItem('promoClosedAt', String(promoCreatedAt));
      else {
        get(siteRef).then(snap => {
          const s = snap.val() || {};
          const promo = s.promocion || {};
          if(promo.createdAt) sessionStorage.setItem('promoClosedAt', String(promo.createdAt));
        }).catch(()=>{});
      }
    }

    // Escuchar turnos en tiempo real
    onValue(turnosRef, (snapshot) => {
      allTurnos = snapshot.val() || {};
      aplicarFiltrosYRender();
    }, (err)=> {
      console.error(err);
      showMessage('Error de conexi√≥n a Firebase', 'error');
    });

    // Debug helpers (exposed so you can call from browser console)
    try {
      window.__app = window.__app || {};
      window.__app.aplicarFiltrosYRender = aplicarFiltrosYRender;
      window.__app.crearCard = crearCard;
      window.__app.allTurnos = allTurnos;
    } catch(e) { /* noop if environment prevents it */ }

    // Floating action button behavior
    try {
      const fab = document.getElementById('fab');
      if(fab){
        fab.addEventListener('click', (e) => {
          const href = fab.getAttribute('data-href');
          if(href){ window.open(href, '_blank', 'noopener'); }
        });
        // prevent keyboard focus outline on mobile tap
        fab.addEventListener('touchstart', ()=>{});
      }
    } catch(e){ /* noop */ }

  </script>
</body>
</html>